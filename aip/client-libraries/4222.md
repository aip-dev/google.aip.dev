---
id: 4222
state: approved
created: 2018-06-22
---

# Routing headers

In some situations, a gRPC API backend is able to route traffic more
efficiently if it knows about some values in the request; however, the request
payload can not be reasonably deconstructed on the wire to perform that
routing.

## Guidance

Code generators **should** use the annotations to generate client libraries that,
on a per-rpc basis extract routing information from the request payload and
add that information to the routing header.

There are two annotations that specify how to extract routing information from
the request payload: the [`google.api.routing`][routing] that specifies how to
construct routing headers explicitly and the [`google.api.http`][http] annotation
that may specify how to construct routing headers implicitly. For any given rpc,
if the explicit routing headers annotation is present, the code generators **should**
use it. If the explicit routing headers annotation is absent, the code generators
**should** parse the [`google.api.http`][http] annotation to see if it specifies
routing headers implicitly, and use that specification.

## Explicit Routing Headers (google.api.routing)
For an unary or server-streaming rpc the code generator **should** look at the routing
parameters specified in the [`google.api.routing`][routing] annotation, if present.
Any given routing parameter specifies a field name and a pattern with exactly one
named resource ID path segment. For example:

```proto
rpc CreateTopic(CreateTopicRequest) {
  option (google.api.routing) = {
    routing_parameters {
      field: "parent"
      path_template: "{project=projects/*}/**"
  }
}
```

**Note:** It is acceptable to omit the pattern in the resource id segment, `{parent}`
for example, is equivalent to `{parent=*}` and **should** be parsed.

**Note** It is acceptable to omit the `path_template` field altogether. An omitted 
`path_template` is equivalent to a `path_template` with the same resource id name as
the field and the pattern `**`, and **should** be parsed, e.g. 

```proto
routing_parameters {
  field: "parent"
}
```

is the same as

```proto
routing_parameters {
  field: "parent"
  path_template: "{parent=**}
}
```

When the user supplies an instance of `CreateTopicRequest` to the method, the
client library **should** match all the routing parameters in the order specified
to the fields of that instance. For each routing parameter, the pattern in the
`path_template` **should** be matched to the input message field specified by the
routing parameter's `field` field. In case of a match, the name of the resource id
path segment should be used as a key, and the value of the resource id path segment match 
should be used as a value of a key-value pair to be appended to the `x-goog-request-params`
header. 

Both the key and the value **must** be URL-encoded per [RFC 6570 ยง3.2.2][].
This can be done with standard library URL encoding. For example, adding this header
to a gRPC request in Ruby:

```ruby
header_params = {}
if (pattern_matches("{project=projects/*}/**", request.parent))
  header_params["project"] = extract_match_value("{project=projects/*}/**", request.parent)
end
request_params_header = URI.encode_www_form header_params
metadata[:"x-goog-request-params"] = request_params_header
```

If a routing parameter's `path_template` pattern did not match the field value, or
if the field was unset, the key-value pair corresponding to that routing parameter's
resource id path segment name should not be sent.

In cases when multiple routing parameters have the same resource id path segment name,
thus referencing the same header key, the `last one wins` rule is used to determine
which value to send. If some of the routing parameters with the same resource id segment
name have failed to match the field, they are not considered when determining which value
to send. If all the routing parameters with the same resource id segment name have failed
to match the field, the key-value pair corresponding to those routing parameters'
resource id path segment name should not be sent.
If none of the routing parameters matched their respective fields, the routing header
**should not** be sent.

Much like URL parameters, if there is more than one key-value pair, the `&`
character is used as the separator.

## Implicit Routing Headers (google.api.http)
**Note:** For an rpc annotated with the [`google.api.routing`][routing] annotation,
the [`google.api.http`][http] annotation should be ignored for the purpose of adding
routing headers.

If an unary or server-streaming rpc is not annotated with the [`google.api.routing`][routing]
annotation, code generators **should** look at URI-based variables declared in the
[`google.api.http`][http] annotation and transcribe these into the
`x-goog-request-params` header in unary calls. A URI-based variable is a
variable declared as a key in curly braces in the URI string. For example:

```proto
rpc CreateTopic(CreateTopicRequest) {
  option (google.api.http).post = "{parent=projects/*}/topics";
}
```

**Note:** It is acceptable to omit the pattern in the resource id segment, `{parent}`
for example, is equivalent to `{parent=*}` and **should** be parsed.

In this case, the applicable variable is `parent`, and it refers to the
`parent` field in `CreateTopicRequest`. When the user provides an instance of
`CreateTopicRequest` to the method (or once the client library has built it, in
the case of method overloads), the client library must extract the key and
value, and append them to the `x-goog-request-params` header. Both the key and
the value **must** be URL-encoded per [RFC 6570 ยง3.2.2][]. This can be done
with standard library URL encoding. For example, adding this header to a gRPC
request in Go:

```go
md := metadata.Pairs("x-goog-request-params",
  url.QueryEscape("parent") + "=" + url.QueryEscape(req.GetParent()))
```

At runtime, if a field with the same name as the named parameter is unset on the
request message, the key-value pair corresponding to that parameter **should not**
be included in the routing header. If none of the parameters should be included in
the routing header, the routing header **should not** be sent.

If the [`google.api.http`][http] annotation contains `additional_bindings`,
these patterns **should** be parsed for additional request parameters. Fields
not duplicated in the top-level (or `additional_bindings`) pattern **should**
be included in request parameters, encoded in the same way.

Much like URL parameters, if there is more than one key-value pair, the `&`
character is used as the separator.

<!-- prettier-ignore -->
[http]: https://github.com/googleapis/googleapis/blob/master/google/api/http.proto
[routing]: https://github.com/googleapis/googleapis/blob/master/google/api/routing.proto
[rfc 6570 ยง3.2.2]: https://tools.ietf.org/html/rfc6570#section-3.2.2

## Changelog

- **2020-04-21**: Explicitly parse path variables missing a trailing segment.
- **2019-11-27**: Include `additional_bindings` as a request parameter source.
- **2019-06-26**: Fix wording and example of key-value pair encoding.
- **2019-06-20**: Specify encoding of header parameters.
