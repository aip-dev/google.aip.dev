---
id: 193
state: approved
created: 2019-07-26
placement:
  category: polish
  order: 30
---

# Errors

Effective error communication is an important part of designing simple and
intuitive APIs. Services returning standardized error responses enable API
clients to construct centralized common error handling logic. This common logic
simplifies API client applications and eliminates the need for cumbersome
custom error handling code.

## Guidance

Services **must** return a [`google.rpc.Status`][Status] message when an API
error occurs, and **must** use the canonical error codes defined in
[`google.rpc.Code`][Code]. More information about the particular codes is
available in the [gRPC status code documentation][].

Error messages **should** help a reasonably technical user _understand_ and
_resolve_ the issue, and **should not** assume that the user is an expert in
your particular API. Additionally, error messages **must not** assume that the
user will know anything about its underlying implementation.

Error messages **should** be brief but actionable. Any extra information
**should** be provided in the `details` field. If even more information is
necessary, you **should** provide a link where a reader can get more
information or ask questions to help resolve the issue.

### Details

Google defines a set of [standard detail payloads][details] for error details,
which cover most common needs for API errors. Services **should** use these
standard details payloads when feasible.

Structured details with machine-readable identifiers **must** be used if users
will need to write code against a specific aspect of the error. Error message
strings **may** change over time; however, if an error message does not have a
machine-readable identifier _in addition to_ the `code` field, changing the
error message **must** be considered a backwards-incompatible change.

#### ErrorInfo

The [`ErrorInfo`][ErrorInfo] message is the required way to send a
machine-readable identifier. All error responses **must** include an
`ErrorInfo` payload in the `details` field. Variable information
**should** be included in the `metadata` field on `ErrorInfo` and
**must** be included if it appears within an error message.

#### Uniqueness

Each type of detail payload **must** be included at most once. For
example, there **must not** be more than one [`BadRequest`][BadRequest]
message in the `details` field, but there **may** be a `BadRequest` and
a [`PreconditionFailure`][PreconditionFailure].

**Note:** `ErrorInfo` represents a special case. There **must** be exactly one
`ErrorInfo`. It is required.

### Error messages

For each error, the service **must** populate the `message` field on [`google.rpc.Status`][Status]. This error message,

- is developer-facing, human-readable, and in the application's
  native language
- both explains the error and offers an actionable resolution to it
  ([citation](https://cloud.google.com/apis/design/errors#error_model))

**Note:** Sometimes, services elect to publish debug error message in
English rather than the application's native language so that messages
are more easily universally searchable in common online knowledge bases.

When introducing a new error, a failure scenario that did not previously
occur for the service, the payload **must** include `ErrorInfo` and any
variables found in dynamic segments of the error message **must** be
represented in `metadata`. See, "[Dynamic
variables](#dynamic-variables)".

#### Changing error messages

If your service's API design governing body decides that a change to
`Status.message` represent a backwards incompatible change, then
`Status.message` **must not** be changed.

If the error message in `Status.message` contains dynamic segments, and
`ErrorInfo` was absent at the time of launch, then `Status.message`
**should not** change. See, "[Dynamic variables](#dynamic-variables)".

**Warning:** **Use extreme caution** when changing `Status.message`. API
consumers often treat this error message as part of the API contract.
They perform string matches on the text to differentiate one error for
another. Also, if there are dynamic segments in the error message,
clients will often parse the text to extract these variables.

A second error message **may** by included by adding
[`google.rpc.LocalizedMessage`][LocalizedMessage] to
[`details`](#details) by populating its `message` field. When including
`LocalizedMessage`, both the `locale` and `message` fields **must** be
populated.

When adding a new error message via `LocalizedMessage`, `ErrorInfo`
**must** be introduced either before or at the same time. If there are
dynamic segments found in messages, these variables **must** be included
in the `metadata` field on `ErrorInfo`, a `map<string, string>`. See,
"[Dynamic variables](#dynamic-variables)".

**Warning:** If `LocalizedMessage` is released without `ErrorInfo`
the same concerns regarding clients misusing textual error messages
apply.

Consider adding the *second error message* with `LocalizedMessage` for
the following reasons:

- To localize or if you plan to localize. See,
  "[Localization](#localization)".
- If requirements dictate that the message displayed to end users is
  different than the "debug message" (found in `message` on `Status`).
- Ongoing, iterative error message improvements are expected,
  especially if dynamic segments are to be relocated (within the text)
  or new variables added.

If the service is localized, the value of `locale` **must**
change. See, "[Localization](#localization)". Otherwise, the field
**must** always contain the service's default locale, e.g. "en-US".

#### Dynamic variables

The best, actionable error messages include dynamic segments. These
variable parts of the message are specific to a particular request.
Consider the following example:

> The Book, "The Great Gatsby", is unavailable at the Library, "Garfield
> East". It is expected to be available again on 2199-05-13.

The preceding error message is made actionable by the context, both that
originates from the request, the title of the Book and the name of the
Library, and by the information that is known only by the service, i.e.
the expected return date of the Book.

All dynamic variables found in error messages **must** also appear in
the `map<string, string>` field, `metadata` (found on the *required*
`ErrorInfo`).  For example, the `metadata` map for the sample error
message above will include *at least* the following key/value pairs:

```yaml
bookTitle: "The Great Gatsby"
library: "Garfield East"
expectedReturnDate: "2199-05-13"
```

Dynamic variables that do not appear in an error message **may** also be
included in `metadata` to provide additional information to the client
to be used programmatically. Keys **must** be expressed as lower
camel-case.

Once present in `metadata`, keys **must** continue to be included in the
map for the error payload to be backwards compatible.

#### Localization

The error message, found in the payload on `Status`, **must** be in
English. If a localized error message is also required, the service
**should** use [`google.rpc.LocalizedMessage`][LocalizedMessage] in the
`details` field.

### Partial errors

APIs **should not** support partial errors. Partial errors add significant
complexity for users, because they usually sidestep the use of error codes, or
move those error codes into the response message, where the user must write
specialized error handling logic to address the problem.

However, occasionally partial errors are necessary, particularly in bulk
operations where it would be hostile to users to fail an entire large request
because of a problem with a single entry.

Methods that require partial errors **should** use [long-running operations][],
and the method **should** put partial failure information in the metadata
message. The errors themselves **must** still be represented with a
[`google.rpc.Status`][Status] object.

### Permission Denied

If the user does not have permission to access the resource or parent,
regardless of whether or not it exists, the service **must** error with
`PERMISSION_DENIED` (HTTP 403). Permission **must** be checked prior to checking
if the resource or parent exists.

If the user does have proper permission, but the requested resource or parent
does not exist, the service **must** error with `NOT_FOUND` (HTTP 404).

## Rationale

`ErrorInfo` is required because it further identifies an error. The
`Status` field, with under 20 [allowed values][Code], is rarely enough
to disambiguate one error from another accross an entire API Service.
Error messages often contain dynamic segments that express values, such
as project numbers or locations, and these values are often read from
the string message using brittle extraction methods, like RegExp. There
needs to be a machine readable component of *every* error response that
enables clients to pull such information programatically--without
parsing the string error message. For these reasons, `ErrorInfo` is
required for *every* error response.

## Further reading

- For which error codes to retry, see [AIP-194](https://aip.dev/194).
- For how to retry errors in client libraries, see
  [AIP-4221](https://aip.dev/client-libraries/4221).

## Changelog

- **2023-05-16**: Specify requirements for changing error messages.
- **2023-05-10**: Require [`ErrorInfo`][ErrorInfo] for all error
  responses.
- **2023-05-04**: Require uniqueness by message type for error details.
- **2022-11-04**: Added guidance around PERMISSION_DENIED errors previously
  found in other AIPs.
- **2022-08-12**: Reworded/Simplified intro to add clarity to the intent.
- **2020-01-22**: Added a reference to the [`ErrorInfo`][ErrorInfo] message.
- **2019-10-14**: Added guidance restricting error message mutability to if
  there is a machine-readable identifier present.
- **2019-09-23**: Added guidance about error message strings being able to
  change.

<!-- prettier-ignore-start -->
[aip-4221]: ../client-libraries/4221.md
[details]: https://github.com/googleapis/googleapis/blob/master/google/rpc/error_details.proto
[ErrorInfo]: https://github.com/googleapis/googleapis/blob/6f3fcc058ff29989f6d3a71557a44b5e81b897bd/google/rpc/error_details.proto#L27-L76
[PreconditionFailure]: https://github.com/googleapis/googleapis/blob/6f3fcc058ff29989f6d3a71557a44b5e81b897bd/google/rpc/error_details.proto#L139-L166
[BadRequest]: https://github.com/googleapis/googleapis/blob/477a59d764428136ba1d857a9633c0d231de6efa/google/rpc/error_details.proto#L168-L218
[LocalizedMessage]: https://github.com/googleapis/googleapis/blob/e9897ed945336e2dc967b439ac7b4be6d2c62640/google/rpc/error_details.proto#L275-L285
[grpc status code documentation]: https://github.com/grpc/grpc/blob/master/doc/statuscodes.md
[Code]: https://github.com/googleapis/googleapis/blob/master/google/rpc/code.proto
[Status]: https://github.com/googleapis/googleapis/blob/master/google/rpc/status.proto
[long-running operations]: ./0151.md
<!-- prettier-ignore-end -->
