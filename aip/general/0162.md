---
id: 162
state: approved
created: 2019-09-17
placement:
  category: design-patterns
  order: 88
---

# Resource Revisions

Some APIs need to have resources with a revision history, where users can
reason about the state of the resource over time. There are several reasons for
this:

- Users may want to be able to roll back to a previous revision, or diff
  against a previous revision.
- An API may create data which is derived in some way from a resource at a
  given point in time. In these cases, it may be desirable to snapshot the
  resource for reference later.

**Note:** We use the word _revision_ to refer to a historical reference for a
particular resource, and intentionally avoid the term _version_, which refers
to the version of an API as a whole.

## Guidance

APIs **may** store a revision history for a resource if it is useful to users.

APIs implementing resources with a revision history **should** abstract resource revisions as nested collection of the resource. The
resource revision type **should** inherit from the parent resource and has a field being the parent resource type.

```proto
message BookRevision {
   // The name of the book revision.
   string name = 1;

   // The snapshot of the book
   Book book = 2 [(google.api.field_behavior) = IMMUTABLE];

  // The timestamp that the revision was created.
  google.protobuf.Timestamp create_time = 3
    [(google.api.field_behavior) = OUTPUT_ONLY];

  // tags set on the resource revisions by service or user.
  repeated string tags = 4;
  [(google.api.field_behavior) = OUTPUT_ONLY];
}
```

- The resource revision **must** contain a field representing the snapshot of the parent resource.
- The resource revision **must** contain a `create_time` field, which
  **should** be a `google.protobuf.Timestamp` (see [AIP-142][]).
- The resource revision **may** contain a repeated field `tags` to represent tags that was set on the resource revision.

### Referencing revisions

When referring to specific revision of a resource, APIs must use the following syntax
`{resource_name}/revisions/{revision_id}`. For example:

publishers/123/books/les-miserables/revisions/c7cfa2a8

### Getting a revision

APIs implementing resource revisions in the standard `Get` method ([AIP-131][]):

```proto
// Gets the details of a book revision.
rpc GetBookRevision(GetBookRevisionRequest) returns (BookRevision) {
  option (google.api.http) = {
    get: "/v1/{name=publishers/*/books/*/revisions/*}"
  };
}

message GetBookRevisionRequest {
  // The name of the book revision.
  //   Example: publishers/123/books/les-miserables
  //
  // In order to retrieve a previous revision of the book, also provide
  // the revision ID.
  //   Example: publishers/123/books/les-miserables/revisions/c7cfa2a8
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "library.googleapis.com/BookRevision"
    }];
}
```

If the user passes a revision ID that does not exist, the API must fail with a `NOT_FOUND` error.

The returned resource revision `should` be a different resource type from the parent resource type.

### Tagging revisions

There are two types of tags: Server defined and user specified.

Service may support `current`, `latest`, `oldest`, etc as preserved keyword tags.

GET /v1/publishers/{publisher}/books/{book}/revisions/{preserved_keyword}

Note that `publishers/{publisher}/books/{book}/revisions/latest` and `publishers/{publisher}/books/{book}` can differ. The latest revision may differ from the current status of the resource.

APIs implementing resource revisions **may** provide a mechanism for users to
tag a specific revision with a user provided name by implementing a "Tag
Revision" custom method:

```proto
rpc TagBookRevision(TagBookRevisionRequest) returns (Book) {
  option (google.api.http) = {
    post: "/v1/{name=publishers/*/books/*/revisions/*}:tagRevision"
    body: "*"
  };
}
```

```proto
message TagBookRevisionRequest {
  // The name of the book revision to be tagged.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "library.googleapis.com/BookRevision"
    }];

  // The tag to apply.
  // The tag should be at most 40 characters, and match `[a-z][a-z0-9-]{3,38}[a-z0-9]`.
  string tag = 2 [(google.api.field_behavior) = REQUIRED];
}
```
- The `name` field **should** require an explicit resource revision to be provided.
  - The field **should** be [annotated as required][aip-203].
  - The field **should** identify the [resource type][aip-123] that it
    references.
- The `tag` field **should** be [annotated as required][aip-203].
  - Additionally, tags **should** restrict letters to lower-case.
- Once a revision is tagged, the API **must** support using the tag in place of
  the revision ID in `name` fields.
  - If the user sends a tag, the API **must** return the tag in the resource's
    `name` field, but the revision ID in the resource's `revision_id` field.
  - If the user sends a revision ID, the API **must** return the revision ID in
    both the `name` field and the `revision_id` field.
- If the user calls the `Tag` method with an existing tag, the request **must**
  succeed and the tag updated to point to the new requested revision ID. This
  allows users to write code against specific tags (e.g. `published`) and the
  revision can change in the background with no code change.
### Listing revisions

APIs implementing resource revisions `should` provide a standard List method for listing the revision history for a resource

```proto
rpc ListBookRevisions(ListBookRevisionsRequest)
    returns (ListBookRevisionsResponse) {
  option (google.api.http) = {
    get: "/v1/{parent=publishers/*/books/*}/revisions"
  };
}
```

```proto
message ListBookRevisionsRequest {
  // The name of the book to list revisions for.
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "library.googleapis.com/Book"
    }];

  // The maximum number of revisions to return per page.
  int32 page_size = 2;

  // The page token, received from a previous ListBookRevisions call.
  // Provide this to retrieve the subsequent page.
  string page_token = 3;
}

message ListBookRevisionsResponse {
  // The revisions of the book.
  repeated BookRevision books = 1;

  // A token that can be sent as `page_token` to retrieve the next page.
  // If this field is omitted, there are no subsequent pages.
  string next_page_token = 2;
}
```

- Revisions must be ordered in reverse chronological order. An `order_by` field **should not** be provided in the list request.

### Child resources

Resources with a revision history **may** have child resources. If they do,
there are two potential variants:

- Child resources where each child resource is a child of the parent resource
  as a whole.
- Child resources where each child resource is a child of _a single revision
  of_ the parent resource.

If a child resource is a child of a single revision, the child resource's name
**must** always explicitly include the parent's revision ID:

    publishers/123/books/les-miserables/revisions/c7cfa2a8/pages/42

If necessary, APIs **may** explicitly support listing child resources across
parent revisions by accepting the `-` syntax. For example:

    GET /v1/publishers/123/books/les-miserables/revisions/-/pages

APIs **should not** include multiple levels of resources with revisions, as
this quickly becomes difficult to reason about.

### Committing revisions

Depending on the resource, different APIs may have different strategies for
when to commit a new revision, such as:

- Commit a new revision any time that there is a change
- Commit a new revision when something important happens
- Commit a new revision when the user specifically asks

APIs **may** use any of these strategies. APIs that want to commit a revision on user request should
handle this with a custom method on the resource:

```proto
rpc CommitBookRevision(CommitBookRevisionRequest) returns (BookRevision) {
  option (google.api.http) = {
    post: "/v1/{name=publishers/*/books/*}:commitRevision"
    body: "*"
  };
}

message CommitBookRequest {
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "library.googleapis.com/Book"
    }];
}
```

- The method **must** use the `POST` HTTP verb.
- The method **should** return a long running operation or resource revision.
- The request message **must** include the `name` field.
- The `revision_id` of the resource revision **should** be a
  string and contain a short, automatically-generated random string. A good
  rule of thumb is the last eight characters of a [UUID version 4 (random)](UUID4).

### Rollback

A common use case for a resource with a revision history is the ability to roll
back to a given revision. APIs **should** handle this with a `Rollback` custom
method:

```proto
rpc RollbackBook(RollbackBookRequest) returns (BookRevision) {
  option (google.api.http) = {
    post: "/v1/{name=publishers/*/books/*}:rollback"
    body: "*"
  };
}
```

- The method **must** use the `POST` HTTP verb.
- The method **should** return a long running operation or resource revision.

```proto
message RollbackBookRequest {
  // The book being rolled back.
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "library.googleapis.com/Book"
    }];

  // The revision ID to roll back to.
  // It must be a revision of the same book.
  //
  //   Example: c7cfa2a8
  string revision_id = 2 [(google.api.field_behavior) = REQUIRED];
}
```

- The request message **must** have a `name` field to identify the resource
  being rolled back.
  - The field **should** be [annotated as required][aip-203].
  - The field **should** identify the [resource type][aip-123] that it
    references.
- The request message **must** include a `revision_id` field.
  - The API **must** fail the request with `NOT_FOUND` if the revision does not
    exist on that resource.
  - The field **should** be [annotated as required][aip-203].

**Note:** When rolling back, the API should return a _new_ revision of the
resource with a _new_ revision ID, rather than reusing the original ID. This
avoids problems with representing the same revision being active for multiple
ranges of time.

### Deleting revisions

Revisions are sometimes expensive to store, and there are valid use cases to
want to remove one or more revisions from a resource's revision history.

APIs **may** define a standard `Delete` ([AIP-135][]) method to delete resource revisions

```proto
rpc DeleteBookRevision(DeleteBookRevisionRequest)
    returns (google.protobuf.Empty) {
  option (google.api.http) = {
    delete: "/v1/{name=publishers/*/books/*/revisions/*}"
  };
}
```

```proto
message DeleteBookRevisionRequest {
  // The name of the book revision to be deleted, with a revision ID explicitly
  // included.
  //
  // Example: publishers/123/books/les-miserables/revisions/c7cfa2a8
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "library.googleapis.com/BookRevision"
    }];
}
```

- Resource revisions **should** be automatically deleted on parent resource deletion.
- If resource revisions meant to have longer lifespan than the parent resource, resource and resource revision
should be side by side resource collections.

## Changelog

- **2023-05-23**: Added a new AIP version of resource revisions.
- **2021-04-27**: Added guidance on returning the resource from Delete Revision.

[aip-123]: ./0123.md
[aip-131]: ./0131.md
[aip-132]: ./0132.md
[aip-135]: ./0135.md
[aip-142]: ./0142.md
[aip-203]: ./0203.md
[UUID4]: https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)
