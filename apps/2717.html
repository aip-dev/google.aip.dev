<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-2717: Patterns for generic fields</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=0b03c3b5">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=0b03c3b5">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=0b03c3b5"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">Workspace</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/2712">
        <span class="aip-number">2712</span>
        API completeness
      </a>
    </li>
    <li class="nav-item">
      <a href="/2713">
        <span class="aip-number">2713</span>
        One team owns each type
      </a>
    </li>
    <li class="nav-item">
      <a href="/2715">
        <span class="aip-number">2715</span>
        Documenting authorization changes
      </a>
    </li>
    <li class="nav-item">
      <a href="/2716">
        <span class="aip-number">2716</span>
        Standard terms in names
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/2717">
        <span class="aip-number">2717</span>
        Patterns for generic fields
      </a>
    </li>
    <li class="nav-item">
      <a href="/2718">
        <span class="aip-number">2718</span>
        References to objects in other APIs
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">Patterns for generic fields</th></tr>
    <tr><td>Number</td><td>2717</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/apps/2717">google.aip.dev/apps/2717</a></td></tr>
    <tr><td>Scope</td><td>Workspace</td></tr>
    <tr><td>State</td><td>Reviewing</td></tr>
    <tr><td>Created</td><td>2018-09-10</td></tr>
    <tr><td>Updated</td><td>2018-09-10</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#oneof">oneof</a></li>
<li><a href="#mapstring-foo">map&lt;string, Foo&gt;</a></li>
<li><a href="#any">Any</a></li>
<li><a href="#struct">Struct</a></li>
</ul>
</li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/apps/2717.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/apps/2717.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/apps">
          Workspace AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        Patterns for generic fields
      </li>
    </ol>
  </nav>
</section>
  <p id="aip-state-banner" class="callout note">
  This AIP is currently under review. This means that the editors have read it
  and are in high-level concurrence, and while it is not yet fully approved, we
  have a good faith expectation that the AIP will be approved in something
  close to its current state.
</p>
  <h4 class="aip-number">AIP-2717</h4>
  <h1 id="patterns-for-generic-fields">Patterns for generic fields</h1>
<p>Developers have several options for how to represent generic values in proto
messages. There are reasons to choose one over the other. Understanding them
will lead to better and more consistent APIs.</p>
<h2 id="guidance">Guidance</h2>
<p>APIs <strong>should</strong> follow a consistent application of <code>oneof</code> vs.
<code>map&lt;string, Foo&gt;</code> vs. <code>Any</code> vs. <code>Struct</code>.</p>
<h3 id="oneof"><code>oneof</code></h3>
<p>A <code>oneof</code> is used to create a restriction on a set of optional fields,
enforcing that only one of them may be set (these fields are still separate
individual fields). A common pattern is to have a message that contains a
single <code>oneof</code> collection of various message types. Such a <code>oneof</code> message is
conceptually similar to a C <code>union</code>, or C++ <code>std::variant</code>. These <strong>should</strong> be
used in most places where a generic message type is needed, in preference to
other approaches.</p>
<p><strong>Note:</strong> Adding additional possible values to an existing <code>oneof</code> is a
non-breaking change, but moving existing fields into or out of a <code>oneof</code> is
breaking (it creates a backwards-incompatible change in Go protobuf stubs).</p>
<h3 id="mapstring-foo"><code>map&lt;string, Foo&gt;</code></h3>
<p>If a more generic structure is needed, a map of strings to objects <strong>may</strong> be
used. Such a map is represented by a normal JSON object, such as
<code>{"a": "foo", "b": "bar"}</code>. The downside to such maps is that they are limited
to flat structures, and they can be difficult to work with because many string
constants may be needed.</p>
<h3 id="any"><code>Any</code></h3>
<p>An <a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/any.proto"><code>Any</code></a> allows any message to be packed into the field. This is
conceptually similar to a "bytes" field containing a serialized message. The
advantage of an <code>Any</code> is that a user-defined proto message can be stored along
with type information. The user must be able to know which kind of object is in
the <code>Any</code>, which complicates the design. The disadvantage is that working with
and debugging any protos is much more complicated since the code may or may not
know how to deserialize the packed message. Also, the developer must contend
with unexpected types of messages in the <code>Any</code>.</p>
<p><code>Any</code> <strong>should not</strong> be used as a request parameter. Request parameters will
either be a fixed set of types, in which case a <code>oneof</code> <strong>should</strong> be used, or
a type descriptor would need to be sent along, in which case a struct
<strong>should</strong> be used, which achieves essentially the same thing with much simpler
semantics.</p>
<!-- prettier-ignore -->
<h3 id="struct"><code>Struct</code></h3>
<p>The <a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/struct.proto"><code>Struct</code></a> message can be used to represent arbitrary nested JSON.
For example, given the following code:</p>
<div class="highlight language-java"><pre><span></span><code><span class="n">Struct</span><span class="p">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">();</span>
<span class="n">Value</span> <span class="n">town</span> <span class="o">=</span> <span class="n">Value</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setStringValue</span><span class="p">(</span><span class="s">&quot;Springfield&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<span class="n">Value</span> <span class="n">population</span> <span class="o">=</span> <span class="n">Value</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setNumberValue</span><span class="p">(</span><span class="mi">273</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<span class="n">builder</span><span class="p">.</span><span class="na">putFields</span><span class="p">(</span><span class="s">&quot;town&quot;</span><span class="p">,</span> <span class="n">town</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="na">putFields</span><span class="p">(</span><span class="s">&quot;population&quot;</span><span class="p">,</span> <span class="n">population</span><span class="p">);</span>
<span class="n">Struct</span> <span class="n">survey</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div>
<p><code>survey</code> would serialize as the actual JSON
<code>{"town": "Springfield": "population": 273}</code>. This message type is fairly
uncommon, and <strong>should</strong> only be used rarely.</p>
<!-- prettier-ignore -->
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>