<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-4117: External Account Credentials (Workload Identity Federation)</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=c165f16d">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=c165f16d">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=c165f16d"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">GSuite</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/4110">
        <span class="aip-number">4110</span>
        Application Default Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4111">
        <span class="aip-number">4111</span>
        Self-signed JWT
      </a>
    </li>
    <li class="nav-item">
      <a href="/4112">
        <span class="aip-number">4112</span>
        Service Account Keys
      </a>
    </li>
    <li class="nav-item">
      <a href="/4113">
        <span class="aip-number">4113</span>
        gcloud CLI Integration
      </a>
    </li>
    <li class="nav-item">
      <a href="/4114">
        <span class="aip-number">4114</span>
        Device Certificate Authentication via Mutual TLS
      </a>
    </li>
    <li class="nav-item">
      <a href="/4115">
        <span class="aip-number">4115</span>
        Default Credentials From Google Virtual Machines
      </a>
    </li>
    <li class="nav-item">
      <a href="/4116">
        <span class="aip-number">4116</span>
        Identity Tokens
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/4117">
        <span class="aip-number">4117</span>
        External Account Credentials (Workload Identity Federation)
      </a>
    </li>
    <li class="nav-item">
      <a href="/4118">
        <span class="aip-number">4118</span>
        Mutual Authentication Using Workload Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4119">
        <span class="aip-number">4119</span>
        mTLS Token Binding
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">External Account Credentials (Workload Identity Federation)</th></tr>
    <tr><td>Number</td><td>4117</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/auth/4117">google.aip.dev/auth/4117</a></td></tr>
    <tr><td>Scope</td><td>Auth</td></tr>
    <tr><td>State</td><td>Approved</td></tr>
    <tr><td>Created</td><td>2020-12-10</td></tr>
    <tr><td>Updated</td><td>2020-12-10</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#prerequisite">Prerequisite</a></li>
<li><a href="#configuration-file-generation-and-usage">Configuration File Generation and Usage</a></li>
</ul>
</li>
<li><a href="#expected-behavior">Expected Behavior</a><ul>
<li><a href="#determining-the-subject-token-in-aws">Determining the subject token in AWS</a></li>
<li><a href="#determining-the-subject-token-in-microsoft-azure-and-url-sourced-credentials">Determining the subject token in Microsoft Azure and URL-sourced credentials</a></li>
<li><a href="#determining-the-subject-token-in-file-sourced-credentials">Determining the subject token in file-sourced credentials</a></li>
<li><a href="#determining-the-subject-token-in-executable-sourced-credentials">Determining the subject token in executable-sourced credentials</a></li>
</ul>
</li>
<li><a href="#changelog">Changelog</a></li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/auth/4117.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/auth/4117.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/auth">
          Auth AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        External Account Credentials (Workload Identity Federation)
      </li>
    </ol>
  </nav>
</section>
  
  <h4 class="aip-number">AIP-4117</h4>
  <h1 id="external-account-credentials-workload-identity-federation">External Account Credentials (Workload Identity Federation)</h1>
<p>Using workload identity federation, your application can access Google Cloud
resources from Amazon Web Services (AWS), Microsoft Azure or any identity
provider that supports OpenID Connect (OIDC) or SAML 2.0.</p>
<p>Traditionally, applications running outside Google Cloud have used service
account keys to access Google Cloud resources. Using identity federation,
you can allow your workload to impersonate a service account. This lets you
access Google Cloud resources directly, eliminating the maintenance and
security burden associated with service account keys.</p>
<p><strong>Note:</strong> Because this AIP describes guidance and requirements in a
language-neutral way, it uses generic terminology which may be imprecise or
inappropriate in certain languages or environments.</p>
<h2 id="guidance">Guidance</h2>
<p>This section describes the general guidance of supporting non-Google external
credentials (AWS, Azure, OIDC and SAML IdPs, etc) as a means of authentication.</p>
<h3 id="prerequisite">Prerequisite</h3>
<p>In order to use workload identity federation to access Google cloud resources
from non-Google cloud platforms, the following steps are needed to configure
workload identity pools, providers, service account impersonation and generate
the JSON configuration file to be used by the auth libraries.</p>
<ul>
<li><a href="https://cloud.google.com/iam/docs/configuring-workload-identity-federation#aws">Configure Workload Identity Federation from AWS</a></li>
<li><a href="https://cloud.google.com/iam/docs/configuring-workload-identity-federation#azure">Configure Workload Identity Federation from Microsoft Azure</a></li>
<li><a href="https://cloud.google.com/iam/docs/configuring-workload-identity-federation#oidc">Configure Workload Identity Federation from an OIDC identity provider</a></li>
<li><a href="https://cloud.google.com/iam/docs/configuring-workload-identity-federation#saml_1">Configure Workload Identity Federation from a SAML identity provider</a></li>
</ul>
<h3 id="configuration-file-generation-and-usage">Configuration File Generation and Usage</h3>
<p>After workload identity federation is configured, the JSON configuration file
should be generated. This sample shows how an AWS configuration file is
generated:</p>
<div class="highlight language-bash"><pre><span></span><code>$ gcloud iam workload-identity-pools create-cred-config <span class="se">\</span>
    projects/<span class="nv">$PROJECT_NUMBER</span>/locations/global/workloadIdentityPools/<span class="nv">$POOL_ID</span>/providers/<span class="nv">$PROVIDER_ID</span> <span class="se">\</span>
    --service-account<span class="o">=</span><span class="nv">$SERVICE_ACCOUNT_EMAIL</span> <span class="se">\</span>
    --aws <span class="se">\</span>
    --output-file<span class="o">=</span><span class="nv">$FILEPATH</span>.json
</code></pre></div>
<p>The following values would need to be replaced:</p>
<ul>
<li><strong>PROJECT_NUMBER</strong>: Project number of the project that contains the workload
  identity pool.</li>
<li><strong>POOL_ID</strong>: ID of the workload identity pool.</li>
<li><strong>PROVIDER_ID</strong>: ID of the workload identity pool provider.</li>
<li><strong>SERVICE_ACCOUNT_EMAIL</strong>: Email address of the service account to
  impersonate.</li>
<li><strong>FILEPATH</strong>: File to save configuration to.</li>
</ul>
<p>If you are using <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">AWS IMDSv2</a>,
an additional flag <code>--enable-imdsv2</code> should be added to the <a href="/sdk/gcloud/reference/iam/workload-identity-pools/create-cred-config"><code>gcloud iam workload-identity-pools create-cred-config</code></a> command:</p>
<div class="highlight language-bash"><pre><span></span><code>$ gcloud iam workload-identity-pools create-cred-config <span class="se">\</span>
    projects/<span class="nv">$PROJECT_NUMBER</span>/locations/global/workloadIdentityPools/<span class="nv">$POOL_ID</span>/providers/<span class="nv">$PROVIDER_ID</span> <span class="se">\</span>
    --service-account<span class="o">=</span><span class="nv">$SERVICE_ACCOUNT_EMAIL</span> <span class="se">\</span>
    --aws <span class="se">\</span>
    --enable-imdsv2 <span class="se">\</span>
    --output-file<span class="o">=</span><span class="nv">$FILEPATH</span>.json
</code></pre></div>
<p>If you wish to configure the service account access token lifetime,
an additional flag <code>--service-account-token-lifetime-seconds</code> should be added to the <a href="/sdk/gcloud/reference/iam/workload-identity-pools/create-cred-config"><code>gcloud iam workload-identity-pools create-cred-config</code></a> command (this example uses an AWS configuration, but the token lifetime can be configured for all workload identity federation providers):</p>
<div class="highlight language-bash"><pre><span></span><code>$ gcloud iam workload-identity-pools create-cred-config <span class="se">\</span>
    projects/<span class="nv">$PROJECT_NUMBER</span>/locations/global/workloadIdentityPools/<span class="nv">$POOL_ID</span>/providers/<span class="nv">$PROVIDER_ID</span> <span class="se">\</span>
    --service-account<span class="o">=</span><span class="nv">$SERVICE_ACCOUNT_EMAIL</span> <span class="se">\</span>
    --aws <span class="se">\</span>
    --service-account-token-lifetime-seconds<span class="o">=</span><span class="nv">$TOKEN_LIFETIME</span> <span class="se">\</span>
    --output-file<span class="o">=</span><span class="nv">$FILEPATH</span>.json
</code></pre></div>
<p>The service-account-token-lifetime-seconds flag is optional. If not provided, this defaults to one hour. The minimum allowed value is 600 (10 minutes) and the maximum allowed value is 43200 (12 hours). If a lifetime greater than one hour is required, the service account must be added as an allowed value in an Organization Policy that enforces the <code>constraints/iam.allowServiceAccountCredentialLifetimeExtension</code> constraint.</p>
<p>The external identities configuration file can be used with
<a href="https://google.aip.dev/auth/4110">Application Default Credentials</a>. In order to use external identities with
Application Default Credentials, the full path to this file should be stored
in the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable.</p>
<div class="highlight language-bash"><pre><span></span><code><span class="nb">export</span> <span class="nv">GOOGLE_APPLICATION_CREDENTIALS</span><span class="o">=</span>/path/to/config.json
</code></pre></div>
<p>The library can now automatically choose the right type of client and initialize
credentials from the context provided in the configuration file:</p>
<div class="highlight language-python"><pre><span></span><code><span class="kn">import</span> <span class="nn">google.auth</span>

<span class="n">credentials</span><span class="p">,</span> <span class="n">project</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
</code></pre></div>
<p>External account credentials can also be initialized explicitly using the
generated configuration file.</p>
<div class="highlight language-python"><pre><span></span><code><span class="c1"># Sample for Azure or OIDC/SAML providers.</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">identity_pool</span>

<span class="n">json_config_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">function_to_get_json_config</span><span class="p">())</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="n">identity_pool</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_info</span><span class="p">(</span><span class="n">json_config_info</span><span class="p">)</span>
<span class="n">scoped_credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">with_scopes</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;https://www.googleapis.com/auth/cloud-platform&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight language-python"><pre><span></span><code><span class="c1"># Sample for AWS.</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">aws</span>

<span class="n">json_config_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">function_to_get_json_config</span><span class="p">())</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_info</span><span class="p">(</span><span class="n">json_config_info</span><span class="p">)</span>
<span class="n">scoped_credentials</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">with_scopes</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;https://www.googleapis.com/auth/cloud-platform&#39;</span><span class="p">])</span>
</code></pre></div>
<h2 id="expected-behavior">Expected Behavior</h2>
<p>The auth libraries should use the information in the JSON configuration file to
retrieve the external credentials and exchange them for Google access tokens
using the GCP Security Token Service (via the token exchange endpoint
<code>https://sts.googleapis.com/v1/token</code>) and then impersonating a service account
by calling the <strong>IamCredentials</strong> <a href="https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken">generateAccessToken</a> API to access GCP
resources.</p>
<p>All external account JSON files must share the following fields:</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>type</td>
<td>Yes</td>
<td align="left">This identifies the new type of credential object. This must be "external_account"</td>
</tr>
<tr>
<td>audience</td>
<td>Yes</td>
<td align="left">This is the STS audience which contains the resource name for the workload identity pool and the provider identifier in that pool.</td>
</tr>
<tr>
<td>subject_token_type</td>
<td>Yes</td>
<td align="left">This is the STS subject token type based on the <a href="https://tools.ietf.org/html/rfc8693#section-3">OAuth 2.0 token exchange spec</a>.</td>
</tr>
<tr>
<td>service_account_impersonation_url</td>
<td>No</td>
<td align="left">This is the URL for the service account impersonation request. If this is not available, the STS returned access token should be directly used without impersonation.</td>
</tr>
<tr>
<td>service_account_impersonation.*</td>
<td>No</td>
<td align="left">This object defines additional service account impersonation options. Only one field is currently supported: â€œtoken_lifetime_seconds": This is the requested access token lifetime, e.g. <code>2800</code>.</td>
</tr>
<tr>
<td>token_url</td>
<td>Yes</td>
<td align="left">This is the STS token exchange endpoint.</td>
</tr>
<tr>
<td>credential_source.*</td>
<td>Yes</td>
<td align="left">This object defines the mechanism used to retrieve the external credential from the local environment so that it can be exchanged for a GCP access token via the STS endpoint.</td>
</tr>
</tbody>
</table>
<p>The auth libraries and applications <strong>must</strong> follow the steps below for all
types of external account credentials:</p>
<ul>
<li>Check <strong>credential_source</strong> to determine the necessary logic to retrieve the
  external credential which should be used to construct the subject token to
  pass to the STS endpoint. This is covered in detail for every credential
  configuration below.</li>
<li>Construct the STS request, based on <a href="https://tools.ietf.org/html/rfc8693">rfc8693</a>:<ul>
<li>STS audience should be constructed using the <strong>audience</strong> field.</li>
<li><strong>grant_type</strong> must be <code>urn:ietf:params:oauth:grant-type:token-exchange</code></li>
<li><strong>requested_token_type</strong> must be
  <code>urn:ietf:params:oauth:token-type:access_token</code></li>
<li><strong>subject_token_type</strong> is the <strong>subject_token_type</strong> field as described in
  the RFC.</li>
<li><strong>subject_token</strong> is the retrieved external credentials. Check the
  subsequent sections on how this is retrieved in various environments.</li>
<li><strong>scope</strong>: the list of space-delimited, case-insensitive OAuth scopes that
  specify the desired scopes of the requested security token in the context
  of the service or resource where the token should be used. If service
  account impersonation is used, the cloud platform or IAM scope should be
  passed to STS and then the customer provided scopes should be passed in the
  <strong>IamCredentials</strong> call to <a href="https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken">generateAccessToken</a>.</li>
<li>The STS token exchange URL should be the <strong>token_url</strong> (e.g.
  <code>https://sts.googleapis.com/v1/token</code>).</li>
</ul>
</li>
<li>Send the STS token exchange request to get the Google access token and its
  expiration.</li>
<li>If the <strong>service_account_impersonation_url</strong> is available, trigger service
  account impersonation flow by POSTing to that endpoint with the previously
  returned Google access token.<ul>
<li>If this is not available, end the flow and just use the STS access token
  for authorization.</li>
<li>The list of scopes also need to be provided for this endpoint. The customer
  provided scopes should be used for this endpoint.</li>
<li>In order to access this API, the (Cloud platform
  <code>https://www.googleapis.com/auth/cloud-platform</code> or IAM scope
  <code>https://www.googleapis.com/auth/iam</code>) are required in the underlying
  access token.</li>
<li>The service account access token lifetime also needs to be provided for this endpoint. The value in
  <strong>service_account_impersonation.token_lifetime_seconds</strong> will be used if it
  was provided, otherwise it will default to 1 hour.</li>
</ul>
</li>
</ul>
<h3 id="determining-the-subject-token-in-aws">Determining the subject token in AWS</h3>
<p>External account configuration JSON files should contain the following
information in the <code>credential_source</code> object to facilitate retrieval of AWS
credentials to be passed as subject tokens to the GCP STS token exchange
endpoint.</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>environment_id</td>
<td>Yes</td>
<td align="left">This is the environment identifier, of format <code>aws${version}</code>. A version should be specified to indicate to the auth library whether breaking changes were introduced to the underlying AWS implementation. So if aws1 is supported in the current version of the library but a credential file with aws2 is provided, an error should be thrown instructing the developer to upgrade to a newer version of the library.</td>
</tr>
<tr>
<td>region_url</td>
<td>Yes</td>
<td align="left">This URL should be used to determine the current AWS region needed for the signed request construction.</td>
</tr>
<tr>
<td>url</td>
<td>No</td>
<td align="left">This AWS metadata server URL should be used to retrieve the access key, secret key and security token needed to sign the <code>GetCallerIdentity</code> request. The $ROLE_NAME should be retrieved from calling this endpoint without any parameter and then calling again with the returned role name appended to this URL: http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME</td>
</tr>
<tr>
<td>regional_cred_verification_url</td>
<td>Yes</td>
<td align="left">This defines the regional AWS <code>GetCallerIdentity</code> action URL. This URL should be used to determine the AWS account ID and its roles. This should not actually be called by the Auth libraries. It should be called on the STS token server. The region should be substituted by SDK, e.g. <code>sts.eu-west-1.amazonaws</code>.com.</td>
</tr>
<tr>
<td>imdsv2_session_token_url</td>
<td>No</td>
<td align="left">Presence of this URL enforces the auth libraries to fetch a Session Token from AWS. This field is required for EC2 instances using IMDSv2. This Session Token would later be used while making calls to the metadata enpoint.</td>
</tr>
</tbody>
</table>
<p>The JSON file for AWS configuration files should have the following form:</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;external_account&quot;</span><span class="p">,</span>
  <span class="nt">&quot;audience&quot;</span><span class="p">:</span> <span class="s2">&quot;//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
  <span class="nt">&quot;subject_token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:aws:token-type:aws4_request&quot;</span><span class="p">,</span>
  <span class="nt">&quot;service_account_impersonation_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$EMAIL:generateAccessToken&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.googleapis.com/v1/token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;credential_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;environment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;aws1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;region_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://169.254.169.254/latest/meta-data/placement/availability-zone&quot;</span><span class="p">,</span>
    <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://169.254.169.254/latest/meta-data/iam/security-credentials&quot;</span><span class="p">,</span>
    <span class="nt">&quot;regional_cred_verification_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.{region}.amazonaws.com?Action=GetCallerIdentity&amp;Version=2011-06-15&quot;</span><span class="p">,</span>
    <span class="nt">&quot;imdsv2_session_token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://169.254.169.254/latest/api/token&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The auth libraries and applications <strong>must</strong> follow the steps below:</p>
<ul>
<li>Check <strong>credential_source</strong> for environment ID. If the environment ID is
  <code>aws${version}</code>, this should be an AWS native credential.</li>
<li>Inspect the version in the environment ID. If this is a newer unexpected
  error, trigger an error that the auth library needs to be updated to handle
  this type of credentials.</li>
<li>Validate the host for the <strong>url</strong>, <strong>regional_url</strong> and
  <strong>imdsv2_session_token_url</strong> fields if they are provided. The host should
  either be <strong>169.254.169.254</strong> or <strong>fd00:ec2::254</strong>.</li>
<li>If <strong>imdsv2_session_token_url</strong> is available, then fetch session token
  from <strong>imdsv2_session_token_url</strong>.</li>
<li>Check the environment variables in the following order (<code>AWS_REGION</code> and
  then the <code>AWS_DEFAULT_REGION</code>) to determine the AWS region. If found, skip
  using the AWS metadata server to determine this value.</li>
<li>If the region environment variable is not provided, use the <strong>region_url</strong>
  to determine the current AWS region. The API returns the zone name, e.g.
  <code>us-east-1d</code>. The region should be determined by stripping the last
  character, e.g. <code>us-east-1</code>.</li>
<li>Check the environment variables <code>ACCESS_ACCESS_KEY_ID</code>,
  <code>AWS_SECRET_ACCESS_KEY</code> and the optional <code>AWS_SESSION_TOKEN</code> for the AWS
  security credentials. If found, skip using the AWS metadata server to
  determine these values.</li>
<li>If <strong>url</strong> is available and the security credentials environment variables
  are not provided:<ul>
<li>Call <strong>url</strong> to retrieve the attached AWS IAM role name to the current
  instance.</li>
<li>Call <strong>url/$ROLE_NAME</strong> to get the access key, secret key and security
  token needed to sign the <code>GetCallerIdentity</code> request.</li>
</ul>
</li>
<li>
<p>Construct the AWS signed request (<a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html">AWS Signature Version 4</a>) using the
  <a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html">GetCallerIdentity</a> <strong>regional_cred_verification_url</strong> (with the region
  substituted). This should be serialized by formatting it as a url-encoded
  JSON and passed as the <strong>subject_token</strong> to STS endpoint.
  Here is a sample of the JSON format used:</p>
<p><div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.us-east-1.amazonaws.com?Action=GetCallerIdentity&amp;Version=2011-06-15&quot;</span><span class="p">,</span>
  <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;x-goog-cloud-target-resource&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;20200228T225005Z&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;x-amz-date&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS4-HMAC-SHA256 Credential=AKIASOZTBDV4D7ABCDEDF/20200228/us-east-1/sts/aws4_request, SignedHeaders=host;x-amz-date,Signature=abcedefdfedfd&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;Authorization&quot;</span>
    <span class="p">},</span> 
    <span class="p">{</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;sts.us-east-1.amazonaws.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;IQoJb3JpZ2luX2VjEIz//////////wEaCXVzLWVh...&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;x-amz-security-token&quot;</span>
    <span class="p">}</span>
  <span class="p">],</span> 
  <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
  <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>
</code></pre></div>
For the AWS token, STS requires a special header <code>x-goog-cloud-endpoint</code> to recognize that the token is for a specific workload identity provider.</p>
</li>
</ul>
<h3 id="determining-the-subject-token-in-microsoft-azure-and-url-sourced-credentials">Determining the subject token in Microsoft Azure and URL-sourced credentials</h3>
<p>External account configuration JSON files should contain the following
information in the <code>credential_source</code> object to facilitate retrieval of Azure
and other URL-sourced credentials to be passed as subject tokens to the GCP STS
token exchange endpoint.</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>Yes</td>
<td align="left">This defines the local metadata server to retrieve the external credentials from. For Azure, this should be the Azure Instance Metadata Service (IMDS) URL used to retrieve the Azure AD access token.</td>
</tr>
<tr>
<td>headers</td>
<td>No</td>
<td align="left">This defines the headers to append to the GET request to credential_source.url.</td>
</tr>
<tr>
<td>format.type</td>
<td>No</td>
<td align="left">This indicates the format of the URL response. This can be either "text" or "json". The default should be "text".</td>
</tr>
<tr>
<td>format.subject_token_field_name</td>
<td>No</td>
<td align="left">Required for JSON URL responses. This indicates the JSON field name where the subject_token should be stored.</td>
</tr>
</tbody>
</table>
<p>The JSON file for URL-sourced configuration files (OIDC / SAML) should have the
following form:</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;external_account&quot;</span><span class="p">,</span>
  <span class="nt">&quot;audience&quot;</span><span class="p">:</span> <span class="s2">&quot;//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
  <span class="nt">&quot;subject_token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:oauth:token-type:jwt&quot;</span><span class="p">,</span>
  <span class="nt">&quot;service_account_impersonation_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$EMAIL:generateAccessToken&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.googleapis.com/v1/token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;credential_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:5000/token&quot;</span><span class="p">,</span>
    <span class="nt">&quot;format&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nt">&quot;subject_token_field_name&quot;</span><span class="p">:</span> <span class="s2">&quot;id_token&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Azure configuration files are a type of OIDC URL-sourced credentials.</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;external_account&quot;</span><span class="p">,</span>
  <span class="nt">&quot;audience&quot;</span><span class="p">:</span> <span class="s2">&quot;//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
  <span class="nt">&quot;subject_token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:oauth:token-type:jwt&quot;</span><span class="p">,</span>
  <span class="nt">&quot;service_account_impersonation_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$EMAIL:generateAccessToken&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.googleapis.com/v1/token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;credential_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;Metadata&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
    <span class="nt">&quot;format&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
      <span class="nt">&quot;subject_token_field_name&quot;</span><span class="p">:</span> <span class="s2">&quot;access_token&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The auth libraries and applications <strong>must</strong> follow the steps below:</p>
<ul>
<li>Check <strong>credential_source</strong> has a <strong>url</strong> field and no <strong>environment_id</strong>,
  otherwise skip the rest of the steps.</li>
<li>An HTTP GET request should be sent to this local <strong>url</strong> while injecting
  the <strong>headers</strong> key/values (if provided in the configuration file) in the
  request header. The request should respond with the external credentials
  subject token to be passed to STS token endpoint.</li>
<li>Before parsing the token, check the <strong>format</strong> field.</li>
<li>If the <strong>format</strong> is not available, assume the external credential returned
  by the URL response is provided in plain text format.</li>
<li>If available, check if the type is <strong>json</strong><ul>
<li>If json, check the <strong>subject_token_field_name</strong>.
  For Azure, this is set to <strong>access_token</strong>.</li>
<li>Parse the file as JSON and then retrieve the external credential from
  the field name based on the value of <strong>subject_token_field_name</strong>.</li>
</ul>
</li>
</ul>
<h3 id="determining-the-subject-token-in-file-sourced-credentials">Determining the subject token in file-sourced credentials</h3>
<p>External account configuration JSON files contain the following information
in the <code>credential_source</code> object to facilitate retrieval of file-sourced
credentials to be passed as subject tokens to the GCP STS token exchange
endpoint.</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>file</td>
<td>Yes</td>
<td align="left">This is the source of the credential. This should be used for a credential locally available. This should take precedence over <code>url</code> when both are provided.</td>
</tr>
<tr>
<td>format.type</td>
<td>No</td>
<td align="left">This indicates the format of the file where the token is stored. This can be either "text" or "json". The default should be "text".</td>
</tr>
<tr>
<td>format.subject_token_field_name</td>
<td>No</td>
<td align="left">Required for JSON file formats. This indicates the JSON field name where the <code>subject_token</code> should be stored.</td>
</tr>
</tbody>
</table>
<p>The JSON file for file-sourced configuration files (OIDC / SAML) should have
the following form:</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;external_account&quot;</span><span class="p">,</span>
  <span class="nt">&quot;audience&quot;</span><span class="p">:</span> <span class="s2">&quot;//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
  <span class="nt">&quot;subject_token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:oauth:token-type:saml2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;service_account_impersonation_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$EMAIL:generateAccessToken&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.googleapis.com/v1/token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;credential_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/run/saml/assertion/token&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The auth libraries and applications <strong>must</strong> follow the steps below:</p>
<ul>
<li>Check <strong>credential_source</strong> has a <strong>file</strong> field and no <strong>environment_id</strong>. If not,
    this is not a file-sourced credential and the proceeding steps do not apply.</li>
<li>Get the external credential from the file location specified by the
  <code>credential_source.file</code> field.</li>
<li>Before parsing the token, check the <strong>format</strong> field.</li>
<li>If the <strong>format</strong> is not available, assume the external credential is
  provided in plain text format.</li>
<li>If available, check if the type is <strong>json</strong><ul>
<li>If json, check the <strong>subject_token_field_name</strong>.</li>
<li>Parse the file as JSON and then retrieve the external credential from
  the field name based on the value of <strong>subject_token_field_name</strong>.</li>
</ul>
</li>
</ul>
<h3 id="determining-the-subject-token-in-executable-sourced-credentials">Determining the subject token in executable-sourced credentials</h3>
<p>External account configuration JSON files contain the following information
in the <code>credential_source</code> object to facilitate retrieval of executable-sourced
credentials to be passed as subject tokens to the GCP STS token exchange
endpoint.</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Required</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>executable</td>
<td>Yes</td>
<td align="left">Holds the information necessary to run the executable.</td>
</tr>
<tr>
<td>executable.command</td>
<td>Yes</td>
<td align="left">Specifies the full command to run to retrieve the subject token. This can include arguments. Must be an absolute path for the program.</td>
</tr>
<tr>
<td>executable.timeout_millis</td>
<td>No</td>
<td align="left">Specifies the timeout duration, in milliseconds. Defaults to 30 seconds when not provided.</td>
</tr>
<tr>
<td>executable.output_file</td>
<td>No</td>
<td align="left">Specifies the absolute path to the output file where the executable will cache the response. By specifying this path, the auth libraries will first check this location before running the executable. The format of the file should match the JSON format expected by the auth libraries defined below.</td>
</tr>
</tbody>
</table>
<p>The JSON file for executable-sourced configuration files (OIDC / SAML) should have
the following form:</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;external_account&quot;</span><span class="p">,</span>
  <span class="nt">&quot;audience&quot;</span><span class="p">:</span> <span class="s2">&quot;//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_ID/providers/$PROVIDER_ID&quot;</span><span class="p">,</span>
  <span class="nt">&quot;subject_token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:oauth:token-type:saml2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://sts.googleapis.com/v1/token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;service_account_impersonation_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$EMAIL@project.iam.gserviceaccount.com:generateAccessToken&quot;</span><span class="p">,</span>
  <span class="nt">&quot;credential_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;executable&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/executable --arg1=value1 --arg2=value2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;timeout_millis&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
      <span class="nt">&quot;output_file&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/cached/credentials&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>To use executable-sourced credentials, the <code>GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES</code> environment variable must be set to <code>1</code>.</p>
<p>Additionally, the executable <strong>must</strong> adhere to the following response format:</p>
<p>Successful responses:</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>version</td>
<td>number</td>
<td align="left">The version of the JSON output. Currently only version 1 is supported.</td>
</tr>
<tr>
<td>success</td>
<td>boolean</td>
<td align="left">The status of the response. True in this case.</td>
</tr>
<tr>
<td>token_type</td>
<td>string</td>
<td align="left">The 3rd party subject token type. Must be <em>urn:ietf:params:oauth:token-type:jwt</em>, <em>urn:ietf:params:oauth:token-type:id_token</em>, or <em>urn:ietf:params:oauth:token-type:saml2</em>.</td>
</tr>
<tr>
<td>id_token OR saml_response</td>
<td>string</td>
<td align="left">The 3rd party OIDC token or SAML response.</td>
</tr>
<tr>
<td>expiration_time</td>
<td>number</td>
<td align="left">The optional 3rd party subject token expiration time in seconds (unix epoch time). Only required in the response when an output file is specified in the credential configuration.</td>
</tr>
</tbody>
</table>
<p>A sample successful executable OIDC response:
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;success&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:oauth:token-type:id_token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;id_token&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;expiration_time&quot;</span><span class="p">:</span> <span class="mi">1620499962</span>
<span class="p">}</span>
</code></pre></div></p>
<p>A sample successful executable SAML response:
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;success&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:ietf:params:oauth:token-type:saml2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;saml_response&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;expiration_time&quot;</span><span class="p">:</span> <span class="mi">1620499962</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Error responses:</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>version</td>
<td>number</td>
<td align="left">The version of the JSON output. Currently only version 1 is supported.</td>
</tr>
<tr>
<td>success</td>
<td>boolean</td>
<td align="left">The status of the response. False in this case.</td>
</tr>
<tr>
<td>code</td>
<td>string</td>
<td align="left">The error code.</td>
</tr>
<tr>
<td>message</td>
<td>string</td>
<td align="left">The error message.</td>
</tr>
</tbody>
</table>
<p>A sample executable error response:
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;success&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;401&quot;</span><span class="p">,</span>
  <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Caller not authorized.&quot;</span>
<span class="p">}</span>
</code></pre></div></p>
<p>The auth libraries and applications <strong>must</strong> follow the steps below:</p>
<ul>
<li>Check <strong>credential_source</strong> has an <strong>executable</strong> field and no <strong>environment_id</strong>. If not,
  this is not a executable-sourced credential and the proceeding steps do not apply.</li>
<li>Retrieve the external credential's executable information from the
  <strong>credential_source.executable</strong> field.</li>
<li>Check that the <code>GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES</code> environment variable is set to <strong>1</strong>. If not, error out.</li>
<li>Before the next step, check if <strong>credential_source.executable.output_file</strong> was specified in the credential configuration.<ul>
<li>If present, check if there is an executable response at that location. </li>
<li>If the response is valid and unexpired, or there is no response at that location, continue execution.</li>
<li>If the response is malformed or invalid, error out.</li>
</ul>
</li>
<li>Ensure the following environment variables will be available to the executable:<ul>
<li><code>GOOGLE_EXTERNAL_ACCOUNT_AUDIENCE</code>: The audience field from the credential configuration. Must always be present.</li>
<li><code>GOOGLE_EXTERNAL_ACCOUNT_TOKEN_TYPE</code>: The subject token type. Must always be present.</li>
<li><code>GOOGLE_EXTERNAL_ACCOUNT_IMPERSONATED_EMAIL</code>: The service account email. Only present when service account impersonation is used.</li>
<li><code>GOOGLE_EXTERNAL_ACCOUNT_OUTPUT_FILE</code>: The output file location from the credential configuration. Only present when specified in the credential configuration.</li>
</ul>
</li>
<li>Run the command specified at <strong>credential_source.executable.command</strong>.<ul>
<li>Fail in the following scenarios:<ul>
<li>The executable failed to complete in the timeout duration specified.</li>
<li>The executable's response is invalid, was unsuccessful or expired.</li>
<li>The executable finished with a non-zero exit code.</li>
</ul>
</li>
</ul>
</li>
<li>Parse the executable response as JSON and then retrieve the external credential from
  the field name based on the value of <strong>token_type</strong>.<ul>
<li>The token_type value must be <strong>urn:ietf:params:oauth:token-type:jwt</strong>,
  <strong>urn:ietf:params:oauth:token-type:id_token</strong>, or <strong>urn:ietf:params:oauth:token-type:saml2</strong>.</li>
<li>If the <strong>token_type</strong> is <strong>urn:ietf:params:oauth:token-type:saml2</strong>, the subject token will be parsed from the <strong>saml_response</strong> field.</li>
<li>Otherwise it will be parsed from the <strong>id_token</strong> field.</li>
</ul>
</li>
</ul>
<h2 id="changelog">Changelog</h2>
<ul>
<li><strong>2021-12-10</strong>: Add AIP for External Account Credentials (AIP 4117).</li>
<li><strong>2022-05-18</strong>: Document executable-sourced credentials (AIP 4117).</li>
<li><strong>2022-08-31</strong>: Document configurable token lifetime (AIP 4117).</li>
</ul>
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>