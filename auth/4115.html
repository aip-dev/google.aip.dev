<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-4115: Default Credentials For Google Cloud Virtual Environments</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=631cebbe">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=631cebbe">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=631cebbe"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">Workspace</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/4110">
        <span class="aip-number">4110</span>
        Application Default Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4111">
        <span class="aip-number">4111</span>
        Self-signed JWT
      </a>
    </li>
    <li class="nav-item">
      <a href="/4112">
        <span class="aip-number">4112</span>
        Service Account Keys
      </a>
    </li>
    <li class="nav-item">
      <a href="/4113">
        <span class="aip-number">4113</span>
        gcloud CLI Integration
      </a>
    </li>
    <li class="nav-item">
      <a href="/4114">
        <span class="aip-number">4114</span>
        Device Certificate Authentication via Mutual TLS
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/4115">
        <span class="aip-number">4115</span>
        Default Credentials For Google Cloud Virtual Environments
      </a>
    </li>
    <li class="nav-item">
      <a href="/4116">
        <span class="aip-number">4116</span>
        Identity Tokens
      </a>
    </li>
    <li class="nav-item">
      <a href="/4117">
        <span class="aip-number">4117</span>
        External Account Credentials (Workload Identity Federation)
      </a>
    </li>
    <li class="nav-item">
      <a href="/4118">
        <span class="aip-number">4118</span>
        Mutual Authentication Using Workload Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4119">
        <span class="aip-number">4119</span>
        mTLS Token Binding
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">Default Credentials For Google Cloud Virtual Environments</th></tr>
    <tr><td>Number</td><td>4115</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/auth/4115">google.aip.dev/auth/4115</a></td></tr>
    <tr><td>Scope</td><td>Auth</td></tr>
    <tr><td>State</td><td>Approved</td></tr>
    <tr><td>Created</td><td>2020-08-13</td></tr>
    <tr><td>Updated</td><td>2020-08-13</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#access-default-mtls-credentials">Access Default mTLS Credentials</a></li>
<li><a href="#request-bound-tokens">Request Bound Tokens</a></li>
</ul>
</li>
<li><a href="#changelog">Changelog</a></li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/auth/4115.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/auth/4115.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/auth">
          Auth AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        Default Credentials For Google Cloud Virtual Environments
      </li>
    </ol>
  </nav>
</section>
  
  <h4 class="aip-number">AIP-4115</h4>
  <h1 id="default-credentials-for-google-cloud-virtual-environments">Default Credentials For Google Cloud Virtual Environments</h1>
<p>If the client runs on Google cloud virtual environments such as <a href="https://cloud.google.com/compute">Google Compute Engine (GCE)</a>, 
<a href="https://cloud.google.com/serverless">Serverless</a>, or <a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes Engine (GKE)</a>, the auth library <strong>may</strong> leverage 
Google’s default mutual TLS (mTLS) credentials and obtain bound tokens for the instance. 
The auth library <strong>may</strong> use the default mTLS credentials and bound tokens to access Google APIs. </p>
<p>mTLS authentication enables authentication of both client and server identities in a TLS handshake. 
Applications running in Google virtual environments can authenticate to Google APIs using X.509 
SPIFFE Verifiable Identity Documents (SVIDs). These SVIDs are X.509 certificates that contain SPIFFE 
IDs specifying the identity of the certificate owner.</p>
<p>Bound tokens are access tokens that are bound to some property of the credentials used to establish 
the mTLS connection. The advantage of bound tokens is that they can be used over secure channels 
established via mTLS credentials with the correct binding information, when appropriate access 
policies have been put in place. Therefore, using bound tokens is more secure than bearer tokens,
which can be stolen and adversarially replayed.</p>
<p>This AIP describes the flow of:</p>
<ol>
<li>Retrieving a configuration through a metadata server (MDS) endpoint. The configuration specifies 
   how to access Google’s default mTLS credentials.</li>
<li>Requesting bound tokens.</li>
</ol>
<p><strong>Note:</strong> Because this AIP describes guidance and requirements in a language-neutral way, it uses 
generic terminology which may be imprecise or inappropriate in certain languages or environments.</p>
<h2 id="guidance">Guidance</h2>
<h3 id="access-default-mtls-credentials">Access Default mTLS Credentials</h3>
<p><strong>Note:</strong> Before trying to use Google’s default mTLS credentials, the client <strong>must</strong> first check if the remote 
Google API endpoint supports mTLS. If the remote endpoint does NOT support mTLS, the client <strong>should</strong> 
connect to the endpoint using TLS. How to check if an endpoint supports mTLS is out of the scope of this 
AIP. If the remote endpoint does support mTLS, the client <strong>should</strong> try to connect using mTLS first 
before falling back to TLS. How to find the remote API’s mTLS endpoint is out of the scope of this AIP.
If users enabled <a href="4">Device Certificate Authentication (DCA)</a>, the client <strong>should</strong> give priority to DCA
as mTLS credentials.</p>
<p>To leverage Google’s default mTLS credentials, the client <strong>should</strong> retrieve configurations from 
MDS. The MDS in all virtual environments (GCE, Serverless, and GKE) exposes an HTTP endpoint that 
serves a configuration that specifies how to access Google's default mTLS credentials. This endpoint 
is called the mTLS configuration endpoint.</p>
<p>The URL of the MDS's mTLS configuration endpoint is: 
<div class="highlight language-None"><pre><span></span><code>http://metadata.google.internal/computeMetadata/v1/instance/platform-security/auto-mtls-configuration
</code></pre></div></p>
<p>The request to the MDS's mTLS configuration endpoint <strong>should</strong> be an HTTP GET request without any 
parameter or payload.</p>
<p>The response from the MDS's mTLS configuration endpoint <strong>should</strong> contain the following 
information:</p>
<ul>
<li>The <strong>Secure Session Agent</strong> address: the client doesn’t have direct access to mTLS credentials. 
  The Secure Session Agent manages default mTLS credentials. The client can only use mTLS 
  credentials through the Secure Session Agent. The address can be an IP:port address or a file path 
  representing a Unix Domain Socket (UDS).</li>
</ul>
<p>The client <strong>must</strong> follow the steps below to access Google’s default mTLS credentials.</p>
<ol>
<li>Check if the remote endpoint supports mTLS. <ul>
<li>If yes, go to step (2).</li>
<li>If not, go to step (3). </li>
</ul>
</li>
<li>Send a request to the MDS's mTLS configuration endpoint. If the request is successful and the 
   response contains a Secure Session Agent address, use the address to access Google's default mTLS
   credentials, and go to step (4). If the request fails or the response contains an empty address,
   go to step (3).</li>
<li>Fall back to TLS [END].</li>
<li>Configure the TLS library to use the Secure Session Agent (<a href="https://github.com/google/s2a-go/tree/main/example">example</a>) for client authentication
   during the mTLS handshake.</li>
</ol>
<h3 id="request-bound-tokens">Request Bound Tokens</h3>
<p>To access Google APIs with bound tokens, the client <strong>should</strong> request tokens from MDS. The MDS in 
all virtual environments (GCE, Serverless, and GKE) exposes an HTTP endpoint that serves access tokens.
This endpoint is called the access token endpoint.</p>
<p>The URL of the MDS's access token endpoint is: 
<div class="highlight language-None"><pre><span></span><code>http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
</code></pre></div></p>
<p>The request to the MDS's access token endpoint <strong>should</strong> be an HTTP GET request. The request <strong>may</strong>
have a “scopes” URL parameter with a list of comma-separated scopes. The auth library <strong>should</strong> allow
the caller to optionally specify a list of custom scopes, and add the “scopes” parameter to the request 
when needed. Depending on the runtime environment, the request for custom scopes <strong>may</strong> be transparently 
ignored or fulfilled by the server.</p>
<p>The response from the MDS's access token endpoint <strong>should</strong> contain an access token in the following 
JSON format:</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
      <span class="nt">&quot;access_token&quot;</span><span class="p">:</span> <span class="s2">&quot;YOUR_ACCESS_TOKEN&quot;</span><span class="p">,</span>
      <span class="nt">&quot;expires_in&quot;</span><span class="p">:</span> <span class="mi">3599</span><span class="p">,</span>
      <span class="nt">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span>
 <span class="p">}</span>
</code></pre></div>
<p>The client <strong>must</strong> follow the steps below to request new access tokens for Google APIs if existing 
tokens expire.</p>
<ol>
<li>Send an HTTP request to the MDS access token endpoint, retrieve the access token from the response 
   and go to step (2).</li>
<li>Attach the token from step (1) to the request to Google APIs.</li>
</ol>
<h2 id="changelog">Changelog</h2>
<ul>
<li><strong>2020-12-14</strong>: Replace note on scopes with more detailed discussion.</li>
<li><strong>2021-07-13</strong>: Clarify GCE equivalent runtimes</li>
<li><strong>2023-02-16</strong>: Add mTLS configuration endpoint and unify the token binding flow.</li>
</ul>
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>