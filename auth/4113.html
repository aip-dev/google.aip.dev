<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-4113: gcloud CLI Integration</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=490c9a6b">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=490c9a6b">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=490c9a6b"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">Workspace</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/4110">
        <span class="aip-number">4110</span>
        Application Default Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4111">
        <span class="aip-number">4111</span>
        Self-signed JWT
      </a>
    </li>
    <li class="nav-item">
      <a href="/4112">
        <span class="aip-number">4112</span>
        Service Account Keys
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/4113">
        <span class="aip-number">4113</span>
        gcloud CLI Integration
      </a>
    </li>
    <li class="nav-item">
      <a href="/4114">
        <span class="aip-number">4114</span>
        Device Certificate Authentication via Mutual TLS
      </a>
    </li>
    <li class="nav-item">
      <a href="/4115">
        <span class="aip-number">4115</span>
        Default Credentials For Google Cloud Virtual Environments
      </a>
    </li>
    <li class="nav-item">
      <a href="/4116">
        <span class="aip-number">4116</span>
        Identity Tokens
      </a>
    </li>
    <li class="nav-item">
      <a href="/4117">
        <span class="aip-number">4117</span>
        External Account Credentials (Workload Identity Federation)
      </a>
    </li>
    <li class="nav-item">
      <a href="/4118">
        <span class="aip-number">4118</span>
        Mutual Authentication Using Workload Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4119">
        <span class="aip-number">4119</span>
        mTLS Token Binding
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">gcloud CLI Integration</th></tr>
    <tr><td>Number</td><td>4113</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/auth/4113">google.aip.dev/auth/4113</a></td></tr>
    <tr><td>Scope</td><td>Auth</td></tr>
    <tr><td>State</td><td>Approved</td></tr>
    <tr><td>Created</td><td>2020-07-31</td></tr>
    <tr><td>Updated</td><td>2020-07-31</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#credentials-generation">Credentials Generation</a></li>
<li><a href="#expected-behaviors">Expected Behaviors</a></li>
</ul>
</li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/auth/4113.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/auth/4113.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/auth">
          Auth AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        gcloud CLI Integration
      </li>
    </ol>
  </nav>
</section>
  
  <h4 class="aip-number">AIP-4113</h4>
  <h1 id="gcloud-cli-integration">gcloud CLI Integration</h1>
<p><a href="https://cloud.google.com/sdk/gcloud/reference">gcloud</a> is the CLI that manages authentication, local configuration,
developer workflow, and interactions with the Google Cloud Platform (GCP) APIs.
gcloud can generate default credentials by obtaining user access credentials
via 3-legged OAuth (3LO) web flow and saving them to well-known locations in
JSON format. These credentials are intended to be consumed by applications
other than gcloud. <a href="https://google.aip.dev/auth/4110">Application Default Credentials (ADC) and Google Unified
Auth Clients (GUAC)</a> <strong>must</strong> support the gcloud default credentials.</p>
<p><strong>Note:</strong> Although the sample code is written in Python, this AIP describes
guidance and requirements in a language-neutral way. It uses generic
terminology which may be imprecise or inappropriate in certain languages or
environments.</p>
<h2 id="guidance">Guidance</h2>
<p>This section describes the general guidance of supporting the gcloud default
credentials.</p>
<h3 id="credentials-generation">Credentials Generation</h3>
<p>gcloud default credentials can be generated via command ‘<a href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login">gcloud auth
application-default login</a>’.</p>
<div class="highlight language-None"><pre><span></span><code>$ gcloud auth application-default login
</code></pre></div>
<p>The generated credentials are saved to well-known locations which vary as
platforms:</p>
<ul>
<li><strong>Linux, Mac</strong>: \$HOME/.config/gcloud/application_default_credentials.json</li>
<li><strong>Windows</strong>: %APPDATA%/gcloud/application_default_credentials.json</li>
</ul>
<p>Below is an example of the gcloud default credentials,</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;fake_id.apps.googleusercontent.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;client_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;fake_secret&quot;</span><span class="p">,</span>
  <span class="nt">&quot;quota_project_id&quot;</span><span class="p">:</span> <span class="s2">&quot;fake_project&quot;</span><span class="p">,</span>
  <span class="nt">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="s2">&quot;fake_token&quot;</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorized_user&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>All the fields are populated by the login response from the Google
authorization backend except for ‘quota_project_id’ which is retrieved from
gcloud’s context. Additionally, the users can override ‘quota_project_id’ with
the ‘--client-id-file’ flag,</p>
<div class="highlight language-None"><pre><span></span><code>$ gcloud auth application-default login --client-id-file=clientid.json
</code></pre></div>
<h3 id="expected-behaviors">Expected Behaviors</h3>
<p>The auth libraries will use the information in the gcloud default credentials
to exchange access tokens with Google authorization backend. The resulting
access tokens will be further used by applications to call GCP APIs.</p>
<p>The auth libraries and applications <strong>must</strong> follow the steps below:</p>
<ul>
<li>
<p>The auth library loads the gcloud default credentials from the well-known
  location (see previous <a href="#credentials-generation">section</a>) of the platform on
  which it runs.</p>
</li>
<li>
<p>The auth library calls Google authorization backend with the refresh token,
  client ID and client secret in the gcloud default credentials and procures an
  access token. The URL for acquiring access tokens from Google authorization
  backend is https://oauth2.googleapis.com/token. Below is an example code with
  <a href="https://google-auth.readthedocs.io/en/latest/index.html">google-auth</a> as the auth library and <a href="https://urllib3.readthedocs.io/en/latest/">urllib3</a> as the http transport.</p>
</li>
</ul>
<div class="highlight language-python"><pre><span></span><code><span class="kn">from</span> <span class="nn">google.oauth2</span> <span class="kn">import</span> <span class="n">_client</span> <span class="k">as</span> <span class="n">google_auth_client</span>
<span class="kn">import</span> <span class="nn">google.auth.transport.urllib3</span> <span class="k">as</span> <span class="nn">google_auth_urllib3</span>
<span class="kn">import</span> <span class="nn">urllib3</span>

<span class="c1"># Create an http transport for communicating with Google authorization backend.</span>
<span class="n">http</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">()</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">google_auth_urllib3</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>

<span class="c1"># Build parameters for the access token request. Assume the gcloud default</span>
<span class="c1"># credentials are deserialized are into a dictionary ‘gcloud_default’</span>
<span class="c1"># in the previous step.</span>
<span class="n">token_uri</span> <span class="o">=</span> <span class="s1">&#39;https://oauth2.googleapis.com/token&#39;</span>
<span class="n">refresh_token</span> <span class="o">=</span> <span class="n">gcloud_default</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">]</span>
<span class="n">client_id</span> <span class="o">=</span> <span class="n">gcloud_default</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">]</span>
<span class="n">client_secret</span> <span class="o">=</span> <span class="n">gcloud_default</span><span class="p">[</span><span class="s1">&#39;client_secret&#39;</span><span class="p">]</span>
<span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://www.googleapis.com/auth/cloud-platform&#39;</span><span class="p">]</span>

<span class="c1"># Obtain an access token.</span>
<span class="n">access_token</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">google_auth_client</span><span class="o">.</span><span class="n">refresh_grant</span><span class="p">(</span>
  <span class="n">request</span><span class="p">,</span> <span class="n">token_uri</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">scopes</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>The application calls GCP API with the access token obtained from the
  previous step. ‘quota_project_id’ in the gcloud default credentials
  <strong>should</strong> be added to the ‘X-Goog-User-Project’ http header so that the
  associated account will be charged for billing and quota.</li>
</ul>
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>