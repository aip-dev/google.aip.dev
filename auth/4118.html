<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-4118: Mutual Authentication Using Workload Credentials</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=3ace135b">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=3ace135b">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=3ace135b"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">Workspace</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/4110">
        <span class="aip-number">4110</span>
        Application Default Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4111">
        <span class="aip-number">4111</span>
        Self-signed JWT
      </a>
    </li>
    <li class="nav-item">
      <a href="/4112">
        <span class="aip-number">4112</span>
        Service Account Keys
      </a>
    </li>
    <li class="nav-item">
      <a href="/4113">
        <span class="aip-number">4113</span>
        gcloud CLI Integration
      </a>
    </li>
    <li class="nav-item">
      <a href="/4114">
        <span class="aip-number">4114</span>
        Device Certificate Authentication via Mutual TLS
      </a>
    </li>
    <li class="nav-item">
      <a href="/4115">
        <span class="aip-number">4115</span>
        Default Credentials For Google Cloud Virtual Environments
      </a>
    </li>
    <li class="nav-item">
      <a href="/4116">
        <span class="aip-number">4116</span>
        Identity Tokens
      </a>
    </li>
    <li class="nav-item">
      <a href="/4117">
        <span class="aip-number">4117</span>
        External Account Credentials (Workload Identity Federation)
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/4118">
        <span class="aip-number">4118</span>
        Mutual Authentication Using Workload Credentials
      </a>
    </li>
    <li class="nav-item">
      <a href="/4119">
        <span class="aip-number">4119</span>
        mTLS Token Binding
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">Mutual Authentication Using Workload Credentials</th></tr>
    <tr><td>Number</td><td>4118</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/auth/4118">google.aip.dev/auth/4118</a></td></tr>
    <tr><td>Scope</td><td>Auth</td></tr>
    <tr><td>State</td><td>Draft</td></tr>
    <tr><td>Created</td><td>2022-09-09</td></tr>
    <tr><td>Updated</td><td>2022-09-09</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#provisioning-workload-credentials-in-google-cloud">Provisioning Workload Credentials in Google Cloud</a></li>
<li><a href="#using-workload-credentials">Using Workload Credentials</a></li>
<li><a href="#expected-behavior">Expected Behavior</a></li>
<li><a href="#obtaining-the-default-mtls-endpoint">Obtaining the Default mTLS Endpoint</a></li>
</ul>
</li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/auth/4118.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/auth/4118.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/auth">
          Auth AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        Mutual Authentication Using Workload Credentials
      </li>
    </ol>
  </nav>
</section>
  <p id="aip-state-banner" class="callout warning">
  This AIP is currently a draft. This means that it is being actively debated
  and discussed, and it may change in non-trivial ways.
</p>
  <h4 class="aip-number">AIP-4118</h4>
  <h1 id="mutual-authentication-using-workload-credentials">Mutual Authentication Using Workload Credentials</h1>
<p>Mutual TLS (a.k.a mTLS) authentication enables authentication of both client and
server identities in a TLS handshake. With workload credentials, applications
running in Google Cloud can authenticate to Google APIs using <a href="https://github.com/spiffe/spiffe/blob/main/standards/X509-SVID.md">X.509 SPIFFE
Verifiable Identity Documents</a> (SVIDs). These SVIDs are X.509 certificates
that contain <a href="https://github.com/spiffe/spiffe/blob/main/standards/SPIFFE-ID.md#2-spiffe-identity">SPIFFE IDs</a> specifying the identity of the certificate owners.
mTLS authentication using X.509 SVIDs occurs when the client uses an X.509 SVID
when performing the TLS handshake.</p>
<p><strong>Note:</strong> Because this AIP describes guidance and requirements in a
language-neutral way, it uses generic terminology which may be imprecise or
inappropriate in certain languages or environments.</p>
<h2 id="guidance">Guidance</h2>
<p>If users enable token binding, they <strong>should</strong> do so via <a href="https://google.aip.dev/auth/4110">ADC</a>. This section
describes the general guidance of supporting such authentication.</p>
<h3 id="provisioning-workload-credentials-in-google-cloud">Provisioning Workload Credentials in Google Cloud</h3>
<p>On Google Cloud, workload credentials should be provisioned using one of the
following methods:</p>
<ul>
<li>
<p><a href="https://cloud.google.com/traffic-director/docs/security-envoy-setup">Set up service security with Envoy</a>.</p>
</li>
<li>
<p><a href="https://cloud.google.com/traffic-director/docs/security-proxyless-setup">Set up service security with proxyless gRPC</a>.</p>
</li>
</ul>
<p>In order for workload credentials to be properly used, the auth libraries
<strong>must</strong> support the automatic switching of the service endpoint to its mTLS
counterpart.</p>
<h3 id="using-workload-credentials">Using Workload Credentials</h3>
<p>Users <strong>should</strong> configure <a href="https://google.aip.dev/auth/4110">ADC</a> to use workload credentials via the
certificate configuration gcloud metadata file. Workload credentials can be
added as a <strong>"cert_configs"</strong> type as follows:</p>
<div class="highlight language-json"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="nt">&quot;cert_configs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;workload&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;cert_path&quot;</span><span class="p">:</span> <span class="nt">&quot;path/to/cert/file&quot;</span>
      <span class="nt">&quot;key_path&quot;</span><span class="p">:</span> <span class="nt">&quot;path/to/key/file&quot;</span>
      <span class="nt">&quot;workload_identity_provider&quot;</span><span class="p">:</span> <span class="nt">&quot;...&quot;</span>
      <span class="nt">&quot;authenticate_as_identity_type&quot;</span><span class="p">:</span> <span class="nt">&quot;gsa/native&quot;</span>
      <span class="nt">&quot;service_account_email&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;keychain&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="err">...</span>
    <span class="p">},</span>
    <span class="nt">&quot;pkcs11&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="err">...</span>
    <span class="p">},</span>
    <span class="nt">&quot;windows&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="err">...</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="nt">&quot;libs&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="err">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>For Linux and macOS platforms, the above metadata file is located in the
well-known gcloud config directory at
<strong>"~/.config/gcloud/certificate_config.json"</strong>. Note that the default location
of this file can be changed using the <code>GOOGLE_API_CERTIFICATE_CONFIG</code>
environment variable.</p>
<p>The following lists the fields of the <strong>"workload"</strong> certificate info type that
are relevant to workload credentials:</p>
<ul>
<li>
<p><strong>"cert_path"</strong>: The specified value will be used as the full path to locate
the workload certificate file. This file <strong>must</strong> contain a PEM-encoded
X.509 certificate chain (ordered from leaf to root) where the leaf
certificate is a valid X.509 SVID. The chain <strong>may</strong> consist of only the
leaf certificate.</p>
</li>
<li>
<p><strong>"key_path"</strong>: The specified value will be used as the full path to locate
the workload private key file. This file must contain a PEM-formatted
private key associated with the X.509 certificate specified by
<strong>“cert_path”</strong>.</p>
</li>
</ul>
<p>The description of the <strong>"workload_identity_provider"</strong>,
<strong>"authenticate_as_identity_type"</strong> and <strong>"service_account_email"</strong> fields can
be found in <a href="https://google.aip.dev/auth/4119">mTLS Token Binding</a>.</p>
<p>To enable mutual authentication to Google APIs using workload credentials, the
<strong>"workload"</strong> section and its <strong>"cert_path"</strong> and <strong>"key_path"</strong> values must be
present in the <strong>"~/.config/gcloud/certificate_config.json"</strong> configuration
file.</p>
<h3 id="expected-behavior">Expected Behavior</h3>
<p>Support for mTLS authentication to Google APIs using workload credentials
<strong>must</strong> give priority to user mTLS endpoint override via client options. The
auth libraries <strong>must</strong> follow the steps below:</p>
<ul>
<li>
<p>Locate the workload certificate and private key files using the above
config file. If one of these files is not present, mTLS using workload
credentials may be disabled. The auth libraries <strong>must</strong> check that the
public and private keys in the certificate and key files match before
passing them to the TLS library.</p>
<ul>
<li>Occasional mismatches may happen, since during certificate rotation the
  client library may read the two files while another process is replacing
  them. In that case, the library <strong>must</strong> retry reading the certificate
  and private key files and checking their match status, up to a maximum
  of four attempts. The library <strong>should</strong> wait for 5 seconds between
  attempts.</li>
<li>If the certificate and private key files are loaded in memory (as
  opposed to being read from disk for every mTLS connection), the auth
  libraries <strong>must</strong> periodically reload them (at least every 10 minutes
  or when the certificate expires) to refresh their copies in memory after
  the infrastructure rotates them. Refreshing the credentials <strong>must</strong> be
  done in a background thread and not upon usage.</li>
</ul>
</li>
<li>
<p>Configure the TLS library to use the found, and matched, certificate and
key for client authentication during the TLS handshake.</p>
</li>
<li>
<p>If the user specifies the endpoint override via client options, use it as is
and connect to the specified endpoint using mTLS.</p>
</li>
<li>
<p>If the user does not specify the endpoint override, use the default mTLS
endpoint if the certificate and key files exist and the default regular
endpoint otherwise.</p>
</li>
</ul>
<p>Note that mTLS 1.3 <strong>must</strong> be the only supported version to preserve client
identity and certificate confidentiality.</p>
<p>One implication of the above logic is that if the user enables mTLS
authentication using workload credentials, provides valid certificate and key
files, and specifies a non-mTLS endpoint override, the client libraries
<strong>should</strong> use the certificate and key anyway and let the server decide what to
do. This avoids introducing client-side logic that parses whether the endpoint
override is an mTLS URL, since the URL pattern may change at any time.</p>
<h3 id="obtaining-the-default-mtls-endpoint">Obtaining the Default mTLS Endpoint</h3>
<p>The default mTLS endpoint for a service <strong>should</strong> be read from the Discovery
Document field <strong>"mtlsRootUrl"</strong> instead of generated via regex patterns.</p>
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>