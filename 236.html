<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-236: Policy preview</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=035702c2">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=035702c2">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=035702c2"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">Workspace</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/1">
        <span class="aip-number">1</span>
        AIP Purpose and Guidelines
      </a>
    </li>
    <li class="nav-item">
      <a href="/2">
        <span class="aip-number">2</span>
        AIP Numbering
      </a>
    </li>
    <li class="nav-item">
      <a href="/3">
        <span class="aip-number">3</span>
        AIP Versioning
      </a>
    </li>
    <li class="nav-item">
      <a href="/8">
        <span class="aip-number">8</span>
        AIP Style and Guidance
      </a>
    </li>
    <li class="nav-item">
      <a href="/9">
        <span class="aip-number">9</span>
        Glossary
      </a>
    </li>
    <li class="nav-item">
      <a href="/100">
        <span class="aip-number">100</span>
        API Design Review FAQ
      </a>
    </li>
    <li class="nav-item">
      <a href="/111">
        <span class="aip-number">111</span>
        Planes
      </a>
    </li>
    <li class="nav-item">
      <a href="/121">
        <span class="aip-number">121</span>
        Resource-oriented design
      </a>
    </li>
    <li class="nav-item">
      <a href="/122">
        <span class="aip-number">122</span>
        Resource names
      </a>
    </li>
    <li class="nav-item">
      <a href="/123">
        <span class="aip-number">123</span>
        Resource types
      </a>
    </li>
    <li class="nav-item">
      <a href="/124">
        <span class="aip-number">124</span>
        Resource association
      </a>
    </li>
    <li class="nav-item">
      <a href="/126">
        <span class="aip-number">126</span>
        Enumerations
      </a>
    </li>
    <li class="nav-item">
      <a href="/127">
        <span class="aip-number">127</span>
        HTTP and gRPC Transcoding
      </a>
    </li>
    <li class="nav-item">
      <a href="/128">
        <span class="aip-number">128</span>
        Declarative-friendly interfaces
      </a>
    </li>
    <li class="nav-item">
      <a href="/129">
        <span class="aip-number">129</span>
        Server-Modified Values and Defaults
      </a>
    </li>
    <li class="nav-item">
      <a href="/130">
        <span class="aip-number">130</span>
        Methods
      </a>
    </li>
    <li class="nav-item">
      <a href="/131">
        <span class="aip-number">131</span>
        Standard methods: Get
      </a>
    </li>
    <li class="nav-item">
      <a href="/132">
        <span class="aip-number">132</span>
        Standard methods: List
      </a>
    </li>
    <li class="nav-item">
      <a href="/133">
        <span class="aip-number">133</span>
        Standard methods: Create
      </a>
    </li>
    <li class="nav-item">
      <a href="/134">
        <span class="aip-number">134</span>
        Standard methods: Update
      </a>
    </li>
    <li class="nav-item">
      <a href="/135">
        <span class="aip-number">135</span>
        Standard methods: Delete
      </a>
    </li>
    <li class="nav-item">
      <a href="/136">
        <span class="aip-number">136</span>
        Custom methods
      </a>
    </li>
    <li class="nav-item">
      <a href="/140">
        <span class="aip-number">140</span>
        Field names
      </a>
    </li>
    <li class="nav-item">
      <a href="/141">
        <span class="aip-number">141</span>
        Quantities
      </a>
    </li>
    <li class="nav-item">
      <a href="/142">
        <span class="aip-number">142</span>
        Time and duration
      </a>
    </li>
    <li class="nav-item">
      <a href="/143">
        <span class="aip-number">143</span>
        Standardized codes
      </a>
    </li>
    <li class="nav-item">
      <a href="/144">
        <span class="aip-number">144</span>
        Repeated fields
      </a>
    </li>
    <li class="nav-item">
      <a href="/145">
        <span class="aip-number">145</span>
        Ranges
      </a>
    </li>
    <li class="nav-item">
      <a href="/146">
        <span class="aip-number">146</span>
        Generic fields
      </a>
    </li>
    <li class="nav-item">
      <a href="/147">
        <span class="aip-number">147</span>
        Sensitive fields
      </a>
    </li>
    <li class="nav-item">
      <a href="/148">
        <span class="aip-number">148</span>
        Standard fields
      </a>
    </li>
    <li class="nav-item">
      <a href="/149">
        <span class="aip-number">149</span>
        Unset field values
      </a>
    </li>
    <li class="nav-item">
      <a href="/151">
        <span class="aip-number">151</span>
        Long-running operations
      </a>
    </li>
    <li class="nav-item">
      <a href="/152">
        <span class="aip-number">152</span>
        Jobs
      </a>
    </li>
    <li class="nav-item">
      <a href="/153">
        <span class="aip-number">153</span>
        Import and export
      </a>
    </li>
    <li class="nav-item">
      <a href="/154">
        <span class="aip-number">154</span>
        Resource freshness validation
      </a>
    </li>
    <li class="nav-item">
      <a href="/155">
        <span class="aip-number">155</span>
        Request identification
      </a>
    </li>
    <li class="nav-item">
      <a href="/156">
        <span class="aip-number">156</span>
        Singleton resources
      </a>
    </li>
    <li class="nav-item">
      <a href="/157">
        <span class="aip-number">157</span>
        Partial responses
      </a>
    </li>
    <li class="nav-item">
      <a href="/158">
        <span class="aip-number">158</span>
        Pagination
      </a>
    </li>
    <li class="nav-item">
      <a href="/159">
        <span class="aip-number">159</span>
        Reading across collections
      </a>
    </li>
    <li class="nav-item">
      <a href="/160">
        <span class="aip-number">160</span>
        Filtering
      </a>
    </li>
    <li class="nav-item">
      <a href="/161">
        <span class="aip-number">161</span>
        Field masks
      </a>
    </li>
    <li class="nav-item">
      <a href="/162">
        <span class="aip-number">162</span>
        Resource Revisions
      </a>
    </li>
    <li class="nav-item">
      <a href="/163">
        <span class="aip-number">163</span>
        Change validation
      </a>
    </li>
    <li class="nav-item">
      <a href="/164">
        <span class="aip-number">164</span>
        Soft delete
      </a>
    </li>
    <li class="nav-item">
      <a href="/165">
        <span class="aip-number">165</span>
        Criteria-based delete
      </a>
    </li>
    <li class="nav-item">
      <a href="/180">
        <span class="aip-number">180</span>
        Backwards compatibility
      </a>
    </li>
    <li class="nav-item">
      <a href="/181">
        <span class="aip-number">181</span>
        Stability levels
      </a>
    </li>
    <li class="nav-item">
      <a href="/182">
        <span class="aip-number">182</span>
        External software dependencies
      </a>
    </li>
    <li class="nav-item">
      <a href="/185">
        <span class="aip-number">185</span>
        API Versioning
      </a>
    </li>
    <li class="nav-item">
      <a href="/190">
        <span class="aip-number">190</span>
        Naming conventions
      </a>
    </li>
    <li class="nav-item">
      <a href="/191">
        <span class="aip-number">191</span>
        File and directory structure
      </a>
    </li>
    <li class="nav-item">
      <a href="/192">
        <span class="aip-number">192</span>
        Documentation
      </a>
    </li>
    <li class="nav-item">
      <a href="/193">
        <span class="aip-number">193</span>
        Errors
      </a>
    </li>
    <li class="nav-item">
      <a href="/194">
        <span class="aip-number">194</span>
        Automatic retry configuration
      </a>
    </li>
    <li class="nav-item">
      <a href="/200">
        <span class="aip-number">200</span>
        Precedent
      </a>
    </li>
    <li class="nav-item">
      <a href="/202">
        <span class="aip-number">202</span>
        Fields
      </a>
    </li>
    <li class="nav-item">
      <a href="/203">
        <span class="aip-number">203</span>
        Field behavior documentation
      </a>
    </li>
    <li class="nav-item">
      <a href="/205">
        <span class="aip-number">205</span>
        Beta-blocking changes
      </a>
    </li>
    <li class="nav-item">
      <a href="/210">
        <span class="aip-number">210</span>
        Unicode
      </a>
    </li>
    <li class="nav-item">
      <a href="/211">
        <span class="aip-number">211</span>
        Authorization checks
      </a>
    </li>
    <li class="nav-item">
      <a href="/213">
        <span class="aip-number">213</span>
        Common components
      </a>
    </li>
    <li class="nav-item">
      <a href="/214">
        <span class="aip-number">214</span>
        Resource expiration
      </a>
    </li>
    <li class="nav-item">
      <a href="/215">
        <span class="aip-number">215</span>
        API-specific protos
      </a>
    </li>
    <li class="nav-item">
      <a href="/216">
        <span class="aip-number">216</span>
        States
      </a>
    </li>
    <li class="nav-item">
      <a href="/217">
        <span class="aip-number">217</span>
        Unreachable resources
      </a>
    </li>
    <li class="nav-item">
      <a href="/231">
        <span class="aip-number">231</span>
        Batch methods: Get
      </a>
    </li>
    <li class="nav-item">
      <a href="/233">
        <span class="aip-number">233</span>
        Batch methods: Create
      </a>
    </li>
    <li class="nav-item">
      <a href="/234">
        <span class="aip-number">234</span>
        Batch methods: Update
      </a>
    </li>
    <li class="nav-item">
      <a href="/235">
        <span class="aip-number">235</span>
        Batch methods: Delete
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/236">
        <span class="aip-number">236</span>
        Policy preview
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">Policy preview</th></tr>
    <tr><td>Number</td><td>236</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/236">google.aip.dev/236</a></td></tr>
    <tr><td>State</td><td>Approved</td></tr>
    <tr><td>Created</td><td>2023-03-30</td></tr>
    <tr><td>Updated</td><td>2023-03-30</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a><ul>
<li><a href="#non-goals">Non-goals</a></li>
<li><a href="#experiments">Experiments</a></li>
<li><a href="#metadata">Metadata</a></li>
<li><a href="#methods">Methods</a></li>
<li><a href="#changes-to-live-policy-api-methods">Changes to live policy API methods</a></li>
<li><a href="#logging">Logging</a></li>
</ul>
</li>
<li><a href="#changelog">Changelog</a></li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/general/0236.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/general/0236.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/general">
          General AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        Policy preview
      </li>
    </ol>
  </nav>
</section>
  
  <h4 class="aip-number">AIP-236</h4>
  <h1 id="policy-preview">Policy preview</h1>
<p>A policy is a resource that provides rules that admit or deny access to other
resources. Generally, the outcome of a policy can be evaluated to a specific set
of outcomes.</p>
<p>Changes to policies without proper validation may have unintended consequences
that can severely impact a customer’s overall infrastructure setup. To safely
update resources, it is beneficial to test these changes via policy rollout
APIs.</p>
<p>Preview is a rollout safety mechanism for policy resources, which gives the
customer the ability to validate the effect of their proposed changes against
production traffic prior to the changes going live. The result of the policy
evaluation against traffic is logged in order to give the customer the data
required to test the correctness of the change.</p>
<p>Firewall policies exemplify a case that is suitable for previewing. A new
configuration can be evaluated against traffic to observe which IPs would be
allowed or denied. This gives the customer the data to guide a decision on
whether to promote the proposed changes to live.</p>
<p>The expected flow for previewing a policy is as follows:</p>
<ol>
<li>The user creates an experiment containing a new policy configuration
   intended to replace the live policy.</li>
<li>The user uses the "startPreview" method to start generating logs which compare
   the live and experiment policy evaluations against live traffic.</li>
<li>The user inspects the logs to determine whether the experiment has the
   intended result.</li>
<li>The user uses the "commit" method to promote the experiment to live.</li>
</ol>
<h2 id="guidance">Guidance</h2>
<h3 id="non-goals">Non-goals</h3>
<p>This proposal is for a safety mechanism for policy rollouts only. Safe rollouts
for non-policy resources are not in scope.</p>
<h3 id="experiments">Experiments</h3>
<p>A new configuration of a policy to be previewed is stored as a nested collection
under the policy. These nested collections are known as experiments.</p>
<p>A hypothetical policy resource called, <code>Policy</code>, is used throughout. It has the
following resource name pattern:</p>
<p><code>projects/{project}/locations/{location}/policies/{policy}</code></p>
<p>The experimental versions of the resource used for previewing or other safe
rollout practices are represented as a nested collection under <code>Policy</code> using a
new resource type. The resource type <strong>must</strong> follow the naming convention
<em>RegularResourceType</em><code>Experiment</code>.</p>
<p>The following pattern is used for the experiment collection:</p>
<p><code>projects/{project}/locations/{location}/policies/{policy}/experiments/{experiment}</code></p>
<p>A proto used to represent an experiment <strong>must</strong> contain the following:</p>
<pre><code>1. The required top-level fields for a resource, like `name` and `etag`
2. The policy message that is being tested itself
3. The field, `preview_metadata`, which contains metadata specific to
   previewing the experiment of a specific resource type.
</code></pre>
<div class="highlight language-proto"><pre><span></span><code><span class="kd">message</span> <span class="nc">PolicyExperiment</span> <span class="p">{</span>

  <span class="c1">// google.api.resource, name, and other annotations and fields</span>

  <span class="c1">// The policy experiment. This Policy will be used to preview the effects of</span>
  <span class="c1">// the change but will not affect live traffic.</span>
  <span class="n">Policy</span> <span class="na">policy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

  <span class="c1">// The metadata associated with this policy experiment.</span>
  <span class="n">PolicyPreviewMetadata</span> <span class="na">preview_metadata</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="p">[(</span><span class="n">google.api.field_behavior</span><span class="p">)</span> <span class="o">=</span> <span class="n">OUTPUT_ONLY</span><span class="p">];</span>

  <span class="c1">// Allows clients to store small amounts of arbitrary data.</span>
  <span class="n">map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="na">annotations</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>The experiment proto <strong>must</strong> have a top-level field with the same type as the
  live policy.<ul>
<li>It <strong>must</strong> be named as the live resource type. For example, if the
  experiment is for FirewallPolicy, then this field <strong>must</strong> be named
  <code>firewall_policy</code>.</li>
<li>The name inside the embedded <code>policy</code> message <strong>must</strong> be the name of the
  live policy.</li>
</ul>
</li>
<li>When the user is ready to promote an experiment, they <strong>must</strong> copy the
  <code>policy</code> message into the live policy and delete the experiment. This can be
  done manually or via a "commit" custom method.</li>
<li>A product <strong>may</strong> support multiple experiments concurrently being previewed
  for a single live policy.<ul>
<li>Each experiment must generate logs having each entry preceded by log_prefix
  so that the user can compare the results of the experiment with the behavior
  of the live policy.</li>
<li>The number of experimental configurations for a given live policy <strong>may</strong> be
  capped at a certain number and the cap <strong>must</strong> be documented.</li>
</ul>
</li>
<li>Cascading deletes <strong>must</strong> occur: if the live policy is deleted, all
  experiments <strong>must</strong> also be deleted.</li>
<li><code>map&lt;string,string&gt;</code> <a href="https://aip.dev/128#annotations">annotations</a> <strong>must</strong> allow clients
  to store small amounts of arbitrary data.</li>
</ul>
<h3 id="metadata">Metadata</h3>
<p><code>preview_metadata</code> tracks all metadata of previewing the experiment. The
messages <strong>must</strong> follow the convention: <em>RegularResourceType</em><code>PreviewMetadata</code>.
This is so the proto can be defined uniquely for each resource type in the
same service with experiments.</p>
<div class="highlight language-proto"><pre><span></span><code><span class="kd">message</span> <span class="nc">PolicyPreviewMetadata</span> <span class="p">{</span>
  <span class="c1">// Possible values of the state of previewing the experiment.</span>
  <span class="kd">enum</span> <span class="n">State</span> <span class="p">{</span>
    <span class="c1">// Default value. This value is unused.</span>
    <span class="na">STATE_UNDEFINED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// The experiment is actively previewing.</span>
    <span class="na">ACTIVE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// The previewing of the experiment has been stopped.</span>
    <span class="na">SUSPENDED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// The state of previewing the experiment.</span>
  <span class="n">State</span> <span class="na">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="c1">// An identifying string common to all logs generated when previewing the</span>
  <span class="c1">// experiment. Searching all logs for this string will isolate the results.</span>
  <span class="kt">string</span> <span class="na">log_prefix</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

  <span class="c1">// The most recent time at which this experiment started previewing.</span>
  <span class="n">google.protobuf.Timestamp</span> <span class="na">start_time</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

  <span class="c1">// The most recent time at which this experiment stopped previewing.</span>
  <span class="n">google.protobuf.Timestamp</span> <span class="na">stop_time</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>PolicyPreviewMetadata</code> <strong>must</strong> have the fields defined in the proto above.<ul>
<li>It <strong>may</strong> have additional fields if the service or resource requires it.</li>
</ul>
</li>
<li>When an experiment is first previewed, <code>preview_metadata</code> <strong>must</strong> be
  absent.<ul>
<li>It is present on the experiment once the "startPreview" method is used.</li>
</ul>
</li>
<li>All <code>preview_metadata</code> fields <strong>must</strong> be output only.</li>
<li><code>state</code> changes between <code>ACTIVE</code> and <code>SUSPENDED</code> when previewing is started
  or stopped. This happens when the "startPreview" or "stopPreview custom methods
  are invoked, respectively.</li>
<li>The first time the "startPreview" custom method is used, the system <strong>must</strong>
  create <code>preview_metadata</code> and do the following:<ul>
<li>It <strong>must</strong> set the <code>state</code> to <code>ACTIVE</code></li>
<li>It <strong>must</strong> populate <code>start_time</code> with the current time.<ul>
<li><code>start_time</code> <strong>must</strong> be updated every time <code>state</code> is changed to
  <code>ACTIVE</code>.</li>
</ul>
</li>
<li>It <strong>must</strong> set a system generated <code>log_prefix</code> string, which is a
  predefined constant hard coded by the system developers.</li>
<li>The same value is used for previewing experiments for the given resource
  type. For example, "FirewallPolicyPreviewLog" for FirewallPolicy.</li>
</ul>
</li>
<li>When the "stopPreview" custom method is used, the system <strong>must</strong> do the
  following:<ul>
<li>It <strong>must</strong> set the <code>state</code> to <code>SUSPENDED</code></li>
<li>It <strong>must</strong> populate the <code>stop_time</code> with the current time.</li>
</ul>
</li>
</ul>
<h3 id="methods">Methods</h3>
<h4 id="create">create</h4>
<ul>
<li>The resource <strong>must</strong> be created using long-running
  <a href="https://aip.dev/133#long-running-create">Create</a> and
  <code>google.longrunning.operation_info.response_type</code> <strong>must</strong> be
  <code>PolicyExperiment</code>.</li>
<li>Creating a new experiment to preview <strong>must</strong> support the following use
cases:<ul>
<li>Preview a new policy.</li>
<li>Preview an update to an already live policy.</li>
<li>Preview a deletion of a current policy.</li>
</ul>
</li>
<li>For the update and delete use cases, the <code>policy</code> field in the experiment
  <strong>must</strong> have the full payload of the live policy copied into it, including
  the name.<ul>
<li>The user <strong>must</strong> set the rules to the new intended state to preview an
  update.</li>
<li>The user <strong>must</strong> set set the rules to represent a no-op to preview a
  delete.</li>
</ul>
</li>
<li>To preview a new policy, the system must do the following:<ul>
<li>If the system does not support a nested collection without a live policy,
  the user <strong>must</strong> create a live policy and set the rules to represent a
  no-op. For example, the rules of a no-op policy <strong>may</strong> be empty.<ul>
<li>An experiment is created as a child of the no-op policy.</li>
</ul>
</li>
</ul>
</li>
<li>If the system supports previewing multiple experiments for a live policy,
  calling "create" more than once <strong>must</strong> create multiple experiments.</li>
</ul>
<h4 id="update">update</h4>
<ul>
<li>The resource <strong>must</strong> be updated using long-running
  <a href="https://aip.dev/134#long-running-update">Update</a> and
  <code>google.longrunning.operation_info.response_type</code> <strong>must</strong> be
  <code>PolicyExperiment</code>.</li>
<li>The name inside <code>policy</code> <strong>must not</strong> change but the other fields can in
  order to change the experiment being previewed because this <code>policy</code> is
  intended to replace the live policy, and the name of the live policy
  <strong>must not</strong> change.</li>
<li>The system <strong>must</strong> set the <code>state</code> to <code>SUSPENDED</code> if the <code>state</code> was <code>ACTIVE</code>
  at the time of an update.<ul>
<li>This is so the user can easily distinguish between different versions of
  the experiment being previewed.</li>
</ul>
</li>
</ul>
<h4 id="get">get</h4>
<ul>
<li>The standard method, <a href="/131">Get</a>, <strong>must</strong> be included for
  <code>PolicyExperiment</code> resource types.</li>
</ul>
<h4 id="list">list</h4>
<ul>
<li>The standard method, <a href="/132">List</a>, <strong>must</strong> be included for
  <code>PolicyExperiment</code> resource types.</li>
<li>Filtering on <code>PolicyPreviewMetadata</code> indicates which experiments are actively
  previewed.<ul>
<li>For example, the following filter string returns a List response with
  experiments being previewed: preview_metadata.state = ACTIVE.</li>
</ul>
</li>
</ul>
<h4 id="delete">delete</h4>
<ul>
<li>The resource <strong>must</strong> be deleted using long-running
  <a href="https://aip.dev/135#long-running-delete">Delete</a> and
  <code>google.longrunning.operation_info.response_type</code> <strong>must</strong> be
  <code>PolicyExperiment</code>.</li>
</ul>
<h4 id="startpreview">startPreview</h4>
<div class="highlight language-proto"><pre><span></span><code><span class="c1">// Starts previewing a PolicyExperiment. This triggers the system to start</span>
<span class="c1">// generating logs to evaluate the PolicyExperiment.</span>
<span class="k">rpc</span> <span class="n">StartPreviewPolicyExperiment</span><span class="p">(</span><span class="n">StartPreviewPolicyExperimentRequest</span><span class="p">)</span>
    <span class="k">returns</span> <span class="p">(</span><span class="n">google.longrunning.Operation</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">post</span><span class="o">:</span> <span class="s">&quot;/v1/{name=policies/*/experiments/*}:startPreview&quot;</span>
    <span class="n">body</span><span class="o">:</span> <span class="s">&quot;*&quot;</span>
  <span class="p">};</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.longrunning.operation_info</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">response_type</span><span class="o">:</span> <span class="s">&quot;PolicyExperiment&quot;</span>
    <span class="n">metadata_type</span><span class="o">:</span> <span class="s">&quot;StartPreviewPolicyExperimentMetadata&quot;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// The request message for the startPreview custom method.</span>
<span class="kd">message</span> <span class="nc">StartPreviewPolicyExperimentRequest</span> <span class="p">{</span>
  <span class="c1">// The name of the PolicyExperiment.</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>This custom method is required.</li>
<li><code>google.longrunning.Operation.metadata_type</code> <strong>must</strong> follow guidance on
  <a href="/151">Long-running operations</a></li>
<li>This method <strong>must</strong> trigger the system to start generating logs to preview
  the experiment.</li>
<li>Whenever the method is called successfully, the system <strong>must</strong> set the
  following values in the <code>PolicyPreviewMetadata</code>:<ul>
<li><code>log_prefix</code> to the predefined constant.</li>
<li><code>start_time</code> to the current time</li>
<li><code>state</code> to <code>ACTIVE</code>.</li>
</ul>
</li>
<li>If the method is called on an experiment with the rules representing a no-op,
  then the system <strong>must</strong> preview the deletion of the live policy.</li>
</ul>
<h4 id="stoppreview">stopPreview</h4>
<div class="highlight language-proto"><pre><span></span><code><span class="c1">// Stops previewing a PolicyExperiment. This triggers the system to stop</span>
<span class="c1">// generating logs to evaluate the PolicyExperiment.</span>
<span class="k">rpc</span> <span class="n">StopPreviewPolicyExperiment</span><span class="p">(</span><span class="n">StopPreviewPolicyExperimentRequest</span><span class="p">)</span>
    <span class="k">returns</span> <span class="p">(</span><span class="n">google.longrunning.Operation</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">post</span><span class="o">:</span> <span class="s">&quot;/v1/{name=policies/*/experiments/*}:stopPreview&quot;</span>
    <span class="n">body</span><span class="o">:</span> <span class="s">&quot;*&quot;</span>
  <span class="p">};</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.longrunning.operation_info</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">response_type</span><span class="o">:</span> <span class="s">&quot;PolicyExperiment&quot;</span>
    <span class="n">metadata_type</span><span class="o">:</span> <span class="s">&quot;StopPreviewPolicyExperimentMetadata&quot;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// The request message for the stopPreview custom method.</span>
<span class="kd">message</span> <span class="nc">StopPreviewPolicyExperimentRequest</span> <span class="p">{</span>
  <span class="c1">// The name of the PolicyExperiment.</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>This custom method is required.</li>
<li><code>google.longrunning.Operation.metadata_type</code> <strong>must</strong> follow guidance on
  <a href="/151">Long-running operations</a></li>
<li>This method <strong>must</strong> trigger the system to stop generating logs to preview the
  experiment.</li>
<li>Whenever the method is called successfully, the system <strong>must</strong> set the
  following values in the <code>PolicyPreviewMetadata</code>:<ul>
<li><code>stop_time</code> to the current time</li>
<li><code>state</code> to <code>SUSPENDED</code></li>
</ul>
</li>
</ul>
<h4 id="commit">commit</h4>
<p>The resource <strong>may</strong> expose a new custom method called "commit" to promote an
experiment. The system copies <code>policy</code> from the experiment into the live policy
and then deletes the experiment.</p>
<p>Declarative clients <strong>may</strong> manually copy fields from an experiment into the
live policy and then delete the experiment rather than calling "commit" if
preferable.</p>
<div class="highlight language-proto"><pre><span></span><code><span class="c1">// Commits a PolicyExperiment. This copies the PolicyExperiment&#39;s policy message</span>
<span class="c1">// to the live policy then deletes the PolicyExperiment.</span>
<span class="k">rpc</span> <span class="n">CommitPolicyExperiment</span><span class="p">(</span><span class="n">CommitPolicyExperimentRequest</span><span class="p">)</span>
    <span class="k">returns</span> <span class="p">(</span><span class="n">google.longrunning.Operation</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">post</span><span class="o">:</span> <span class="s">&quot;/v1/{name=policies/*/experiments/*}:commit&quot;</span>
    <span class="n">body</span><span class="o">:</span> <span class="s">&quot;*&quot;</span>
  <span class="p">};</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.longrunning.operation_info</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">response_type</span><span class="o">:</span> <span class="s">&quot;google.protobuf.Empty&quot;</span>
    <span class="n">metadata_type</span><span class="o">:</span> <span class="s">&quot;CommitPolicyExperimentMetadata&quot;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// The request message for the commit custom method.</span>
<span class="kd">message</span> <span class="nc">CommitPolicyExperimentRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">etag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">parent_etag</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>google.longrunning.Operation.metadata_type</code> <strong>must</strong> follow guidance on
  <a href="/151">Long-running operations</a></li>
<li>The method <strong>must</strong> atomically copy <code>policy</code> from the experiment into the live
  policy, and then delete the experiment.</li>
<li>If any experiment fails "commit", previewing it <strong>must not</strong> stop, and the
  live policy <strong>must not</strong> be updated.</li>
<li>The method can be called on an experiment in any state.</li>
<li>The <code>etag</code> <strong>must</strong> match that of the experiment in order for commit to be
  successful. This is so the user does not commit an unintended version of the
  experiment.<ul>
<li>If no <code>etag</code> is provided, the API <strong>must not</strong> succeed to prevent the user
  from unintentionally committing a different version of the experiment as
  intended.</li>
<li>A <code>parent_etag</code> <strong>may</strong> be provided to guarantee that the experiment
  overwrites a specific version of the live policy.</li>
</ul>
</li>
<li>The method is not idempotent and calling it twice on the same experiment
  <strong>must</strong> return a 404 NOT_FOUND as the experiment is deleted as part of the
  first call.</li>
</ul>
<h3 id="changes-to-live-policy-api-methods">Changes to live policy API methods</h3>
<h4 id="delete_1">delete</h4>
<ul>
<li>A delete of the live policy <strong>must</strong> delete all experiments.</li>
<li>To maintain the experiments while negating the effect of the live policy, the
  live policy <strong>must</strong> be changed to a no-op policy instead of using this
  method.</li>
</ul>
<h3 id="logging">Logging</h3>
<p>Logging is crucial for the user to evaluate whether an experiment should be
promoted to live.</p>
<p>Logs <strong>must</strong> contain the results of the evaluated experiment, the <code>etag</code>
associated with that experiment alongside that of the live policy, and be
preceded by the value of <code>log_prefix</code>.
  - The <code>etag</code> fields help the user identify which
    configurations of the live and experiment are evaluated in the log.
  - <code>log_prefix</code> helps the user separate logs specifically generated for
    previewing the experiment from other use cases.</p>
<p>Overall, these logs help the user make a decision about whether to promote the
experiment to live.</p>
<h2 id="changelog">Changelog</h2>
<ul>
<li><strong>2023-04-27:</strong> Methods for start and stop renamed. State to enum. Annotations
  added.</li>
<li><strong>2023-03-30:</strong> Initial AIP written.</li>
</ul>
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>