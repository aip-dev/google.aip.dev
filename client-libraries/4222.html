<!DOCTYPE html>
<html lang="en-US" class="glue-flexbox">
  <head>
    <title>AIP-4222: Routing headers</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link href="//fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Google+Sans:400,500|Product+Sans:400&amp;lang=en" rel="stylesheet"></link>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" media="screen" href="//www.gstatic.com/glue/v22_1/glue.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=035702c2">
    <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css?v=035702c2">
    <script type="text/javascript" src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="//www.gstatic.com/glue/latest/glue-detect.min.js"></script>
    <script type="text/javascript">
      $('html').css('visibility', 'hidden');
      $.when($.ready).then(() => {
        $('html').css('visibility', 'visible');
      });
    </script>
    <script type="text/javascript" src="/assets/js/global.js?v=035702c2"></script>
    
<script type="text/javascript" src="/assets/js/syntax.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140054909-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-140054909-1');
    </script>
  </head>
  <body>
    <!-- prettier-ignore -->
<header class="glue-header glue-header--single">
  <div class="glue-header__bar glue-header__bar--desktop glue-header__drawer">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- LINK BAR-->
      <div class="glue-header__container glue-header__container--flex-auto">
        <nav class="glue-header__link-bar">
          <ul id="list-1" class="glue-header__list">
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/general" aria-level="1">Browse AIPs</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/news" aria-level="1">News</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/faq" aria-level="1">FAQ</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="/contributing" aria-level="1">Contributing</a>
                </li>
              
            
              
                <li class="glue-header__item">
                  <a class="glue-header__link" href="https://linter.aip.dev/" target="_blank" aria-level="1">
                    API Linter
                    <svg role="img" class="glue-icon glue-icon--18px">
                      <use xlink:href="/assets/images/glue-icons.svg#open-in-new"></use>
                    </svg>
                  </a>
                </li>
              
            
          </ul>
        </nav>
      </div>
      <!-- CTA-->
      <div class="glue-header__container glue-header__container--cta">
        <div class="glue-header__cta">
        <div class="glue-sitesearch">
          <form method="GET" action="/search">
          <label for="q">Search this site</label>
          <input class="glue-sitesearch__input" type="text" name="q" id="q"
            placeholder="Search AIPs">
          <button type="submit" class="glue-button glue-sitesearch__submit" title="Submit">
            <svg role="img" class="glue-icon glue-icon--24px">
            <use xlink:href="/assets/images/glue-icons.svg#search"></use>
            </svg>
          </button>
          </form>
        </div>
        <a href="https://github.com/aip-dev/google.aip.dev" target="_blank" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile header placeholder -->
  <div class="glue-header__bar glue-header__bar--mobile">
    <div class="glue-header__tier">
      <!-- LOCK up-->
      <div class="glue-header__container">
        <div class="glue-header__lock-up">
          <div class="glue-header__hamburger glue-header__hamburger--first-tier">
            <div class="glue-header__hamburger-wrapper">
              <button type="button" class="glue-header__drawer-toggle-btn"
                aria-controls="drawer" aria-expanded="false" aria-label="Open the navigation drawer">
                <svg role="img" class="glue-icon glue-icon--24px"><use xlink:href="/assets/images/glue-icons.svg#menu"></use></svg>
              </button>
            </div>
          </div>
          <div class="glue-header__logo">
            <a class="glue-header__logo-link" href="/" title="Google">
              <div class="glue-header__logo-container">
                <svg role="img" aria-hidden="true" class="glue-header__logo-svg">
                  <use xlink:href="/assets/images/glue-icons.svg#google-color-logo"></use>
                </svg>
              </div>
              <p class="glue-header__logo--product">AIPs</p>
            </a>
          </div>
          <!-- SKIP -->
          <a href="#page-content" class="glue-header__skip-content">
            <p class="glue-header__skip-content-text">Jump to Content</p>
          </a>
        </div>
      </div>
      <!-- CTA -->
      <div class="glue-header__container">
        <div class="glue-header__cta">
        <a href="https://github.com/aip-dev/google.aip.dev" class="glue-button glue-button--high-emphasis">
          <img src="/assets/images/github.png" class="github-logo">
          View on GitHub
        </a>
        </div>
      </div>
    </div>
  </div>
  <div class="glue-header__drawer-backdrop"></div>
</header>
    <div class="glue-page">
      
      <main role="main" id="page-content">
        
<nav id="aip-nav" class="docs-component-nav">
  <ul class="nav-list">
    <li class="nav-item nav-item-header">AIPs by Scope</li>
    <li class="nav-item">
      <a href="/general">General</a>
    </li>
    <li class="nav-item">
      <a href="/cloud">Google Cloud Platform</a>
    </li>
    <li class="nav-item">
      <a href="/auth">Auth</a>
    </li>
    <li class="nav-item">
      <a href="/client-libraries">Client libraries</a>
    </li>
    <li class="nav-item">
      <a href="/apps">Workspace</a>
    </li>
    <li class="nav-item">
      <a href="/aog">Actions on Google</a>
    </li>
    <li class="nav-item nav-item-header">AIPs</li>
    <li class="nav-item">
      <a href="/4210">
        <span class="aip-number">4210</span>
        Client library generators
      </a>
    </li>
    <li class="nav-item">
      <a href="/4221">
        <span class="aip-number">4221</span>
        Client-side retry
      </a>
    </li>
    <li class="nav-item nav-item-active">
      <a href="/4222">
        <span class="aip-number">4222</span>
        Routing headers
      </a>
    </li>
    <li class="nav-item">
      <a href="/4223">
        <span class="aip-number">4223</span>
        Client-side payload validation
      </a>
    </li>
    <li class="nav-item">
      <a href="/4231">
        <span class="aip-number">4231</span>
        Parsing resource names
      </a>
    </li>
    <li class="nav-item">
      <a href="/4232">
        <span class="aip-number">4232</span>
        Method signatures
      </a>
    </li>
    <li class="nav-item">
      <a href="/4233">
        <span class="aip-number">4233</span>
        Automatic pagination
      </a>
    </li>
    <li class="nav-item">
      <a href="/4234">
        <span class="aip-number">4234</span>
        Common service client mixins
      </a>
    </li>
    <li class="nav-item">
      <a href="/4235">
        <span class="aip-number">4235</span>
        Automatically populate fields in the request message
      </a>
    </li>
    <li class="nav-item">
      <a href="/4236">
        <span class="aip-number">4236</span>
        Version-aware clients
      </a>
    </li>
    <li class="nav-item">
      <a href="/4290">
        <span class="aip-number">4290</span>
        Docker interface
      </a>
    </li>
    </ul>
</nav>
<section id="jump-content">
          
<aside id="aip-sidebar" class="docs-component-sidebar">
  <table id="aip-summary">
    <tr><th colspan="2">Routing headers</th></tr>
    <tr><td>Number</td><td>4222</td></tr>
    <tr><td>Permalink</td><td><a href="https://google.aip.dev/client-libraries/4222">google.aip.dev/client-libraries/4222</a></td></tr>
    <tr><td>Scope</td><td>Client libraries</td></tr>
    <tr><td>State</td><td>Approved</td></tr>
    <tr><td>Created</td><td>2018-06-22</td></tr>
    <tr><td>Updated</td><td>2018-06-22</td></tr>
  </table>

  <section id="aip-toc" class="docs-component-sidebar-toc">
    <div class="toc"><span class="toctitle">Contents</span><ul>
<li><a href="#guidance">Guidance</a></li>
<li><a href="#explicit-routing-headers-googleapirouting">Explicit Routing Headers (google.api.routing)</a><ul>
<li><a href="#path_template-syntax">path_template syntax</a></li>
</ul>
</li>
<li><a href="#implicit-routing-headers-googleapihttp">Implicit Routing Headers (google.api.http)</a></li>
<li><a href="#changelog">Changelog</a></li>
</ul>
</div>

  </section>

  <section class="docs-component-sidebar-actions">
    <ul>
      <li><a href="https://github.com/aip-dev/google.aip.dev/issues/">File Bug</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/blob/master/aip/client-libraries/4222.md">View source</a></li>
      <li><a href="https://github.com/aip-dev/google.aip.dev/edit/master/aip/client-libraries/4222.md">Edit this page</a></li>
    </ul>
  </section>
</aside>
<section id="aip-main" class="docs-component-main">
  <section class="section-breadcrumbs">
  <nav
    class="glue-breadcrumbs glue-mod-mt-std glue-mod-mb-std"
    aria-label="You are here."
  >
    <ol class="glue-breadcrumbs__list aip-breadcrumbs">
      <li class="glue-breadcrumbs__item" aria-level="1">
        <a class="glue-breadcrumbs__link" href="/">
          API Improvement Proposals
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item" aria-level="2">
        <a class="glue-breadcrumbs__link" href="/client-libraries">
          Client libraries AIPs
        </a>
      </li>
      
      <li class="glue-breadcrumbs__item glue-breadcrumbs__item--active"
          aria-level="3">
        Routing headers
      </li>
    </ol>
  </nav>
</section>
  
  <h4 class="aip-number">AIP-4222</h4>
  <h1 id="routing-headers">Routing headers</h1>
<p>In some situations, a gRPC API backend is able to route traffic more
efficiently if it knows about some values in the request; however, the request
payload can not be reasonably deconstructed on the wire to perform that
routing.</p>
<h2 id="guidance">Guidance</h2>
<p>Code generators <strong>must</strong> use the annotations to generate client libraries that,
on a per-RPC basis, extract routing information from the request payload and
add that information to the routing header.</p>
<p>There are two annotations that specify how to extract routing information from
the request payload:</p>
<ul>
<li>the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/routing.proto"><code>google.api.routing</code></a> annotation that specifies how to construct 
routing headers explicitly </li>
<li>the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto"><code>google.api.http</code></a> annotation that may specify how to construct 
routing headers implicitly.</li>
</ul>
<p>For any given RPC, if the explicit routing headers annotation is present, the code
generators <strong>must</strong> use it and ignore any routing headers that might be implicitly
specified in the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto"><code>google.api.http</code></a> annotation. If the explicit routing
headers annotation is absent, the code generators <strong>must</strong> parse the
<a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto"><code>google.api.http</code></a> annotation to see if it specifies routing headers
implicitly, and use that specification.</p>
<h2 id="explicit-routing-headers-googleapirouting">Explicit Routing Headers (<code>google.api.routing</code>)</h2>
<p>For an unary or server-streaming RPC the code generator <strong>must</strong> look at the routing
parameters specified in the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/routing.proto"><code>google.api.routing</code></a> annotation, if present.
Any given routing parameter specifies a field name and a pattern with exactly one
named resource ID path segment. For example:</p>
<div class="highlight language-proto"><pre><span></span><code><span class="k">rpc</span> <span class="n">CreateTopic</span><span class="p">(</span><span class="n">CreateTopicRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.api.routing</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">routing_parameters</span> <span class="p">{</span>
      <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
      <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;{project=projects/*}/**&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The value of the field <code>field</code> <strong>must</strong> be one of the following:</p>
<ol>
<li>a name of a field in the top-level of the request message</li>
<li>a dot-separated path of field names leading to a field in a sub-message of
the request message e.g. <code>"book.author.name"</code> where <code>book</code> is a message field in
the request message, <code>author</code> is a message field in the <code>book</code> message, and
<code>name</code> is a <code>string</code> field in the <code>author</code> message</li>
</ol>
<p>The <em>actual field</em> specified in the field <code>field</code> <strong>must</strong> have the following
characteristics:
- it is type <code>string</code>
- it either has a path-like value format resembling a resource name or contains
  an unstructured value that would be appropriate as an individual path segment
  e.g. a <code>project_id</code>. </p>
<p><strong>Note:</strong> An empty <code>google.api.routing</code> annotation is acceptable. It means that no
routing headers should be generated for the RPC, when they otherwise would be
e.g. implicitly from the <code>google.api.http</code> annotation.</p>
<p><strong>Note:</strong> It is acceptable to omit the pattern in the resource ID segment, <code>{parent}</code>
for example, is equivalent to <code>{parent=*}</code> and <strong>must</strong> be parsed, e.g.:
<div class="highlight language-proto"><pre><span></span><code><span class="n">routing_parameters</span> <span class="p">{</span>
  <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
  <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;projects/{parent}&quot;</span>
<span class="p">}</span>
</code></pre></div></p>
<p>is the same as</p>
<div class="highlight language-proto"><pre><span></span><code><span class="n">routing_parameters</span> <span class="p">{</span>
  <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
  <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;projects/{parent=*}&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Note:</strong> It is acceptable to omit the <code>path_template</code> field altogether. An omitted 
<code>path_template</code> is equivalent to a <code>path_template</code> with the same resource ID name as
the field and the pattern <code>**</code>, and <strong>must</strong> be parsed, e.g.:
<div class="highlight language-proto"><pre><span></span><code><span class="n">routing_parameters</span> <span class="p">{</span>
  <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
<span class="p">}</span>
</code></pre></div></p>
<p>is the same as</p>
<div class="highlight language-proto"><pre><span></span><code><span class="n">routing_parameters</span> <span class="p">{</span>
  <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
  <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;{parent=**}&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Note:</strong> An omitted <code>path_template</code> field does not indicate that key-value
pairs with empty values can be sent. It's merely a shorthand.</p>
<p>When the user supplies an instance of <code>CreateTopicRequest</code> to the method, the
client library <strong>must</strong> match all the routing parameters in the order specified
to the fields of that instance. For each routing parameter, the pattern in the
<code>path_template</code> <strong>must</strong> be matched to the input message field specified by the
routing parameter's <code>field</code> field. In case of a match, the name of the resource ID
path segment must be used as a key, and the value of the resource ID path segment match 
must be used as a value of a key-value pair to be appended to the <code>x-goog-request-params</code>
header. </p>
<p>Both the key and the value <strong>must</strong> be URL-encoded per <a href="https://tools.ietf.org/html/rfc6570#section-3.2.2">RFC 6570 §3.2.2</a>.
This can be done with standard library URL encoding. For example, adding this header
to a gRPC request in Ruby:</p>
<div class="highlight language-ruby"><pre><span></span><code><span class="n">header_params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pattern_matches</span><span class="p">(</span><span class="s2">&quot;{project=projects/*}/**&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
  <span class="n">header_params</span><span class="o">[</span><span class="s2">&quot;project&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">extract_match_value</span><span class="p">(</span><span class="s2">&quot;{project=projects/*}/**&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">request_params_header</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode_www_form</span> <span class="n">header_params</span>
<span class="n">metadata</span><span class="o">[</span><span class="ss">:&quot;x-goog-request-params&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">request_params_header</span>
</code></pre></div>
<p>In cases when multiple routing parameters have the same resource ID path segment name,
thus referencing the same header key, the "last one wins" rule is used to determine
which value to send. The "last" here is meant in terms of the order in which they're specified in the annotation. If some of the routing parameters with the same resource ID segment
name have failed to match the field, or if the field was unset, or if the extracted matched value
is an empty string, these parameters are not considered when determining which value
to send.</p>
<p>Example:</p>
<div class="highlight language-proto"><pre><span></span><code><span class="k">option</span> <span class="p">(</span><span class="n">google.api.routing</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">routing_parameters</span> <span class="p">{</span>
    <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
    <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;{project=projects/*}/**&quot;</span>
  <span class="p">}</span>
  <span class="n">routing_parameters</span> <span class="p">{</span>
    <span class="n">field</span><span class="o">:</span> <span class="s">&quot;parent&quot;</span>
    <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;{project=projects/*/subprojects/*}/**&quot;</span>
  <span class="p">}</span>
  <span class="n">routing_parameters</span> <span class="p">{</span>
    <span class="n">field</span><span class="o">:</span> <span class="s">&quot;billing_project&quot;</span>
    <span class="n">path_template</span><span class="o">:</span> <span class="s">&quot;{project=**}&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>In this case if in a given request the <code>billing_project</code> field is set to an non-empty value,
its value will be sent with the <code>project</code> key because the routing parameter looking at <code>billing_project</code> field is specified last. If the <code>billing_project</code> field is not set, the <code>parent</code> field will be considered, first trying to send a
project with a subproject specified, and then without. Note that if a given request has a
<code>parent</code> field with a value e.g. <code>projects/100/subprojects/200/foo</code>, patterns in both first and second <code>routing_parameters</code> will match it, but the second one will "win" since it is specified "last".</p>
<p>If all the routing parameters with the same resource ID segment name have failed
to match the field, the key-value pair corresponding to those routing parameters'
resource ID path segment name <strong>must not</strong> be sent.</p>
<p>If none of the routing parameters matched their respective fields, the routing header
<strong>must not</strong> be sent.</p>
<p>Much like URL parameters, if there is more than one key-value pair to be sent, the <code>&amp;</code>
character is used as the separator.</p>
<h3 id="path_template-syntax"><code>path_template</code> syntax</h3>
<p>As seen in the above examples, the <code>path_template</code> can use a variety of symbols
that are interpreted by code generators during conversion to regular expressions
or non-regular expression matcher implementations. The <code>path_template</code> consists
of segments delimited by the segment delimiter. The syntax for <code>path_template</code>
is as follows:</p>
<ul>
<li>The only acceptable segment delimiter is <code>/</code>.<ul>
<li>The last symbol in a <code>path_template</code> <strong>may</strong> be a delimiter - it will be 
  ignored.</li>
</ul>
</li>
<li>A segment <strong>must</strong> be of one of the following types:<ul>
<li><code>*</code>: A single-segment wildcard. Corresponds to 1 or more non-<code>/</code> symbols.
  The regex describing it is <code>[^/]+</code>.<ul>
<li>A Single-segment wildcard typically represents a resource ID.</li>
</ul>
</li>
<li><code>**</code>: A multi-segment wildcard. Corresponds to 0 or more segments. <ul>
<li>A multi-segment wildcard <strong>must</strong> only appear as the final segment or
  make up the entire <code>path_template</code>.</li>
<li>In a multi-segment <code>path_template</code>, a multi-segment wildcard <strong>must</strong>
  appear immediately following a segment delimiter. This delimiter is
  consumed while matching so a <code>path_template</code> like <code>foo/**</code> matches all of
  the following: <code>foo</code>, <code>foo/</code>, <code>foo/bar/baz</code>.</li>
<li>In a multi-segment <code>path_template</code>, when used as the last segment the
  regex describing it is <code>([:/].*)?</code>.</li>
<li>When used as the entire <code>path_template</code>, the regex describing it is <code>.*</code>.</li>
<li>Segment delimiters are consumed while matching, including any preceding
  delimiter.</li>
</ul>
</li>
<li><code>LITERAL</code>: A literal segment. A literal segment can contain any
  alphanumeric symbol.<ul>
<li>A literal segment <strong>must not</strong> contain a symbol reserved in this syntax.</li>
<li>Literal segments typically represent a resource collection ID or base
  path.</li>
</ul>
</li>
<li><code>{}</code>: A variable segment. This matches part of the path as specified by its
  template.<ul>
<li>A variable segment can be either of the following:<ul>
<li><code>{key}</code>, where <code>key</code> is the name to be used in the key-value pair of the
  header</li>
<li><code>{key=template}</code>, where the <code>template</code> is the segment(s) (expressed in
  this <code>path_template</code> syntax) to extract as the value paired with <code>key</code></li>
</ul>
</li>
<li>A variable segment of just <code>{key}</code> defaults to a template of <code>*</code> which
  matches 1 or more non-<code>/</code> symbols.<ul>
<li>While <code>{key=*}</code> is technically valid syntax, the simpler syntax of
  <code>{key}</code> <strong>should</strong> be used.</li>
</ul>
</li>
<li>A variable segment <strong>must not</strong> contain other variable segments. This
  syntax is not recursive.</li>
</ul>
</li>
</ul>
</li>
<li>A segment <strong>must not</strong> represent a complex resource ID as described in
  <a href="./4231.md#complex-resource-id-path-segments">AIP-4231</a>. A Generator <strong>should</strong> emit an error in this case.</li>
</ul>
<h2 id="implicit-routing-headers-googleapihttp">Implicit Routing Headers (<code>google.api.http</code>)</h2>
<p><strong>Note:</strong> For an RPC annotated with the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/routing.proto"><code>google.api.routing</code></a> annotation,
the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto"><code>google.api.http</code></a> annotation must be ignored for the purpose of adding
routing headers.</p>
<p>If an unary or server-streaming RPC is not annotated with the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/routing.proto"><code>google.api.routing</code></a>
annotation, code generators <strong>must</strong> look at URI-based variables declared in the
<a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto"><code>google.api.http</code></a> annotation and transcribe these into the
<code>x-goog-request-params</code> header in unary calls. A URI-based variable is a
variable declared as a key in curly braces in the URI string. For example:</p>
<div class="highlight language-proto"><pre><span></span><code><span class="k">rpc</span> <span class="n">CreateTopic</span><span class="p">(</span><span class="n">CreateTopicRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span><span class="o">.</span><span class="na">post</span> <span class="o">=</span> <span class="s">&quot;{parent=projects/*}/topics&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Note:</strong> It is acceptable to omit the pattern in the resource ID segment, <code>{parent}</code>
for example, is equivalent to <code>{parent=*}</code> and <strong>must</strong> be parsed.</p>
<p>In this case, the applicable variable is <code>parent</code>, and it refers to the
<code>parent</code> field in <code>CreateTopicRequest</code>. When the user provides an instance of
<code>CreateTopicRequest</code> to the method (or once the client library has built it, in
the case of method overloads), the client library must extract the key and
value, and append them to the <code>x-goog-request-params</code> header. Both the key and
the value <strong>must</strong> be URL-encoded per <a href="https://tools.ietf.org/html/rfc6570#section-3.2.2">RFC 6570 §3.2.2</a>. This can be done
with standard library URL encoding. For example, adding this header to a gRPC
request in Go:</p>
<div class="highlight language-go"><pre><span></span><code><span class="nx">md</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Pairs</span><span class="p">(</span><span class="s">&quot;x-goog-request-params&quot;</span><span class="p">,</span>
  <span class="nx">url</span><span class="p">.</span><span class="nx">QueryEscape</span><span class="p">(</span><span class="s">&quot;parent&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">QueryEscape</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">GetParent</span><span class="p">()))</span>
</code></pre></div>
<p>At runtime, if a field with the same name as the named parameter is unset on the
request message, the key-value pair corresponding to that parameter <strong>must not</strong>
be included in the routing header. If none of the parameters must be included in
the routing header, the routing header <strong>must not</strong> be sent.</p>
<p>If the <a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto"><code>google.api.http</code></a> annotation contains <code>additional_bindings</code>,
these patterns <strong>must</strong> be parsed for additional request parameters. Fields
not duplicated in the top-level (or <code>additional_bindings</code>) pattern <strong>must</strong>
be included in request parameters, encoded in the same way.</p>
<p>Much like URL parameters, if there is more than one key-value pair, the <code>&amp;</code>
character is used as the separator.</p>
<!-- prettier-ignore -->
<h2 id="changelog">Changelog</h2>
<ul>
<li><strong>2023-07-07</strong>: Include <code>path_template</code> syntax.</li>
<li><strong>2022-07-13</strong>: Updated to include the new <code>google.api.routing</code> annotation.</li>
<li><strong>2020-04-21</strong>: Explicitly parse path variables missing a trailing segment.</li>
<li><strong>2019-11-27</strong>: Include <code>additional_bindings</code> as a request parameter source.</li>
<li><strong>2019-06-26</strong>: Fix wording and example of key-value pair encoding.</li>
<li><strong>2019-06-20</strong>: Specify encoding of header parameters.</li>
</ul>
  <footer>
  Except as otherwise noted, the content of this page is licensed under the
  <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
  Attribution 4.0 License</a>, and code samples are licensed under the
  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
  <span class="no-print">For details, see <a href="/licensing">content
  licensing</a>.</span>
</footer>
</section>

        </section>
      </main>
      
    </div>
    <script src="//www.gstatic.com/external_hosted/hammerjs/v2_0_2/hammer.min.js"></script>
    <script src="//www.gstatic.com/glue/v22_1/glue-vanilla.min.js"></script>
    <script type="text/javascript">
      const headerElement = document.querySelector('.glue-header');
      if (headerElement) {
        new window.glue.ui.header.Header(headerElement);
      }
    </script>
  </body>
</html>